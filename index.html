-- 1. Add missing columns to qr_codes
ALTER TABLE qr_codes
  ADD COLUMN IF NOT EXISTS url text,
  ADD COLUMN IF NOT EXISTS color text DEFAULT '#C85A3E',
  ADD COLUMN IF NOT EXISTS details text DEFAULT '',
  ADD COLUMN IF NOT EXISTS status text DEFAULT 'draft',
  ADD COLUMN IF NOT EXISTS include_logo boolean DEFAULT true,
  ADD COLUMN IF NOT EXISTS media jsonb DEFAULT '[]'::jsonb,
  ADD COLUMN IF NOT EXISTS files jsonb DEFAULT '[]'::jsonb,
  ADD COLUMN IF NOT EXISTS photo text,
  ADD COLUMN IF NOT EXISTS updated_at timestamptz DEFAULT now();

-- 2. Enable Row Level Security
ALTER TABLE qr_codes ENABLE ROW LEVEL SECURITY;
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE memories ENABLE ROW LEVEL SECURITY;

-- 3. QR codes policies
CREATE POLICY "Users can view own QR codes"
  ON qr_codes FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own QR codes"
  ON qr_codes FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own QR codes"
  ON qr_codes FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own QR codes"
  ON qr_codes FOR DELETE
  USING (auth.uid() = user_id);

-- 4. Profiles policies
CREATE POLICY "Users can view own profile"
  ON profiles FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON profiles FOR UPDATE
  USING (auth.uid() = id);

CREATE POLICY "Users can insert own profile"
  ON profiles FOR INSERT
  WITH CHECK (auth.uid() = id);

-- 5. Memories policies (uses qr_code_id linked to qr_codes)
CREATE POLICY "Users can view memories for own QR codes"
  ON memories FOR SELECT
  USING (qr_code_id IN (SELECT id FROM qr_codes WHERE user_id = auth.uid()));

CREATE POLICY "Users can insert memories for own QR codes"
  ON memories FOR INSERT
  WITH CHECK (qr_code_id IN (SELECT id FROM qr_codes WHERE user_id = auth.uid()));

CREATE POLICY "Users can update memories for own QR codes"
  ON memories FOR UPDATE
  USING (qr_code_id IN (SELECT id FROM qr_codes WHERE user_id = auth.uid()));

CREATE POLICY "Users can delete memories for own QR codes"
  ON memories FOR DELETE
  USING (qr_code_id IN (SELECT id FROM qr_codes WHERE user_id = auth.uid()));
