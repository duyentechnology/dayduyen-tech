<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duy·ªÅn - Complete Demo</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #FDF8F5;
            color: #3D2E24;
        }
        
        /* Views */
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }
        
        /* Header */
        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(61, 46, 36, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo-header-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
        }
        
        .logo-symbol {
            font-size: 36px;
            color: #C85A3E;
            line-height: 1;
        }
        
        .logo-text-wrapper {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .logo-text {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 32px;
            font-weight: 600;
            color: #C85A3E;
            letter-spacing: 3px;
            line-height: 1;
        }
        
        .logo-tagline {
            font-size: 11px;
            color: #9A8478;
            font-style: italic;
            line-height: 1;
        }
        
        .cta-button {
            background: #C85A3E;
            color: white;
            padding: 12px 32px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .cta-button:hover {
            background: #b04a2e;
            transform: translateY(-2px);
        }
        
        .user-menu {
            display: none;
            align-items: center;
            gap: 15px;
        }
        
        .user-menu.active {
            display: flex;
        }
        
        .user-email {
            color: #7D6E64;
            font-size: 14px;
        }
        
        /* Landing Page */
        .hero {
            text-align: center;
            padding: 80px 40px;
            max-width: 900px;
            margin: 0 auto;
        }
        
        .hero-symbol {
            font-size: 100px;
            color: #C85A3E;
            display: block;
            margin-bottom: 20px;
        }
        
        .hero-text {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 64px;
            font-weight: 600;
            color: #C85A3E;
            letter-spacing: 4px;
            margin-bottom: 15px;
        }
        
        .hero-tagline {
            font-size: 20px;
            color: #7D6E64;
            font-style: italic;
            margin-bottom: 40px;
        }
        
        .hero h1 {
            font-size: 42px;
            margin-bottom: 25px;
        }
        
        .hero-description {
            font-size: 20px;
            color: #7D6E64;
            line-height: 1.8;
            margin-bottom: 40px;
        }
        
        .btn-primary {
            background: #C85A3E;
            color: white;
            padding: 18px 48px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            font-size: 18px;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(200, 90, 62, 0.3);
        }
        
        .btn-primary:hover {
            background: #b04a2e;
            transform: translateY(-2px);
        }
        
        /* Auth Modal */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(61, 46, 36, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .auth-modal.active {
            display: flex;
        }
        
        .auth-container {
            background: white;
            border-radius: 24px;
            padding: 50px;
            max-width: 480px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .auth-logo .symbol {
            font-size: 60px;
            color: #C85A3E;
            display: block;
            margin-bottom: 10px;
        }
        
        .auth-logo .text {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 36px;
            font-weight: 600;
            color: #C85A3E;
            letter-spacing: 3px;
        }
        
        .auth-title {
            font-size: 24px;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .auth-subtitle {
            color: #7D6E64;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .form-group input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #E8DDD6;
            border-radius: 12px;
            font-size: 16px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #C85A3E;
        }
        
        .btn-auth {
            width: 100%;
            padding: 16px;
            background: #C85A3E;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .btn-auth:hover {
            background: #b04a2e;
        }
        
        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            color: #7D6E64;
        }
        
        .auth-toggle button {
            background: none;
            border: none;
            color: #C85A3E;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }

        .btn-social {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 14px;
            border: 2px solid #E8DDD6;
            border-radius: 12px;
            background: white;
            font-size: 15px;
            font-weight: 600;
            color: #3D2E24;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            margin-bottom: 10px;
        }

        .btn-social:hover {
            border-color: #B08968;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(61, 46, 36, 0.08);
        }

        .auth-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 20px 0;
            color: #9A8478;
            font-size: 13px;
        }

        .auth-divider::before, .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #E8DDD6;
        }
        
        /* Verification */
        .verification-box {
            background: linear-gradient(135deg, #81B29A 0%, #6A9B84 100%);
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            text-align: center;
        }
        
        .verification-box p {
            color: white;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .verification-box button {
            background: white;
            color: #81B29A;
            border: none;
            padding: 16px 40px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Mode Selection */
        .mode-selection {
            max-width: 1000px;
            margin: 40px auto;
            padding: 40px;
        }
        
        .mode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }
        
        .mode-card {
            background: white;
            border: 2px solid #E8DDD6;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mode-card:hover {
            transform: translateY(-5px);
            border-color: #C85A3E;
            box-shadow: 0 10px 30px rgba(200, 90, 62, 0.15);
        }
        
        .mode-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .mode-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .mode-description {
            color: #7D6E64;
            line-height: 1.7;
            margin-bottom: 25px;
        }
        
        .mode-button {
            background: #C85A3E;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            display: inline-block;
        }
        
        /* Generator */
        .generator {
            max-width: 1000px;
            margin: 40px auto;
            padding: 40px;
            background: white;
            border-radius: 24px;
        }
        
        .generator h2 {
            margin-bottom: 30px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .input-field {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #E8DDD6;
            border-radius: 12px;
            font-size: 16px;
        }
        
        .qr-result {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 2px solid #FDF8F5;
        }
        
        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }
        
        .qr-item {
            background: white;
            padding: 25px;
            border-radius: 16px;
            border: 2px solid #E8DDD6;
            box-shadow: 0 4px 15px rgba(61, 46, 36, 0.08);
        }
        
        .qr-code {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            border: 2px solid #E8DDD6;
        }
        
        .qr-label {
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 16px;
            color: #C85A3E;
            text-align: center;
        }
        
        /* Color Selection */
        .color-section {
            margin-bottom: 30px;
        }
        
        .color-presets {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        .color-preset {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .color-preset:hover {
            transform: scale(1.1);
            border-color: #3D2E24;
        }
        
        .color-preset.selected {
            border-color: #C85A3E;
            box-shadow: 0 0 0 3px rgba(200, 90, 62, 0.2);
        }
        
        .color-input-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        input[type="color"] {
            width: 80px;
            height: 50px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
        }
        
        /* Product Data Forms */
        .product-data-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            border: 3px solid #C85A3E;
            box-shadow: 0 6px 20px rgba(200, 90, 62, 0.15);
        }
        
        .product-data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #C85A3E;
        }
        
        .product-data-header h5 {
            color: #C85A3E;
            font-size: 20px;
            font-weight: 700;
            margin: 0;
        }
        
        .photo-upload-area {
            border: 3px dashed #C85A3E;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .photo-upload-area:hover {
            background: linear-gradient(135deg, #ffe5e5 0%, #ffd5d5 100%);
            border-color: #b04a2e;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(200, 90, 62, 0.2);
        }
        
        .file-upload-area {
            border: 3px dashed #3D2E24;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: linear-gradient(135deg, #f7f7ff 0%, #eeeef5 100%);
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .file-upload-area:hover {
            background: linear-gradient(135deg, #eeeef5 0%, #e0e0ed 100%);
            border-color: #2d2d44;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(61, 64, 91, 0.15);
        }
        
        .media-item, .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            background: white;
            border: 1px solid #E8DDD6;
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .media-item .remove-btn, .file-item .remove-btn {
            margin-left: auto;
            background: #fed7d7;
            color: #c53030;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .voice-recorder {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .rec-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #553c9a 0%, #6b46c1 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .rec-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(107, 70, 193, 0.4);
        }
        
        .rec-btn.recording {
            background: linear-gradient(135deg, #c53030 0%, #e53e3e 100%);
            animation: rec-glow 1.5s ease-in-out infinite;
        }
        
        @keyframes rec-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(197, 48, 48, 0.4); }
            50% { box-shadow: 0 0 20px rgba(197, 48, 48, 0.8); }
        }
        
        .rec-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .rec-pulse {
            width: 12px;
            height: 12px;
            background: #c53030;
            border-radius: 50%;
            animation: pulse 1s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }
        
        .qr-card {
            background: white;
            border-radius: 16px;
            border: 2px solid #E8DDD6;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .qr-card:hover {
            border-color: #C85A3E;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(200, 90, 62, 0.15);
        }
        
        .qr-card-preview {
            background: #fafafa;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .qr-card-preview canvas {
            max-width: 120px;
            max-height: 120px;
        }
        
        .qr-card-body {
            padding: 16px;
        }
        
        .qr-card-label {
            font-weight: 700;
            font-size: 15px;
            color: #3D2E24;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .qr-card-meta {
            font-size: 12px;
            color: #9A8478;
            margin-bottom: 10px;
        }
        
        .qr-card-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .qr-badge {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .qr-badge.media { background: #fef3c7; color: #92400e; }
        .qr-badge.files { background: #ede9fe; color: #5b21b6; }
        .qr-badge.details { background: #dcfce7; color: #166534; }
        .qr-badge.active { background: #dcfce7; color: #166534; }
        .qr-badge.draft { background: #fee2e2; color: #991b1b; }
        
        .batch-field-group {
            background: white;
            border-radius: 12px;
            border: 2px solid #E8DDD6;
            margin-bottom: 12px;
            overflow: hidden;
            transition: border-color 0.3s;
        }
        
        .batch-field-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 18px;
            cursor: pointer;
            user-select: none;
            font-weight: 600;
            font-size: 14px;
            color: #3D2E24;
        }
        
        .batch-field-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #C85A3E;
            cursor: pointer;
        }
        
        .batch-field-content {
            display: none;
            padding: 0 18px 18px;
        }
        
        .batch-field-group.field-active {
            border-color: #C85A3E;
        }
        
        .batch-field-group.field-active .batch-field-content {
            display: block;
        }
        
        .qr-card.batch-mode {
            position: relative;
        }
        
        .qr-card.batch-mode .batch-checkbox-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 5;
        }
        
        .qr-card.batch-mode.batch-selected {
            border-color: #C85A3E;
            box-shadow: 0 0 0 3px rgba(200, 90, 62, 0.2);
        }
        
        .qr-card-data {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            cursor: pointer;
            border-radius: 10px;
            padding: 6px;
            margin-left: -6px;
            margin-right: -6px;
            transition: background 0.2s;
        }
        
        .qr-card-data:hover {
            background: rgba(200, 90, 62, 0.04);
        }
        
        .card-data-box {
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
        }
        
        .card-data-photo {
            padding: 0;
            overflow: hidden;
            border-radius: 8px;
        }
        
        .card-data-media {
            background: #fffbeb;
            border: 1px solid #fde68a;
        }
        
        .card-data-files {
            background: #f3f0ff;
            border: 1px solid #E8DDD66fe;
        }
        
        .card-data-details {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
        }
        
        .card-data-box-label {
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            color: #555;
        }
        
        .card-data-row {
            padding: 2px 0;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .card-data-text {
            color: #555;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .qr-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .card-action-btn {
            flex: 1;
            padding: 8px 0;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .card-action-btn:hover {
            opacity: 0.85;
        }
        
        .card-action-edit {
            background: #C85A3E;
            color: white;
        }
        
        .card-action-download {
            background: #E8DDD6;
            color: #3D2E24;
        }
        
        .photo-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin: 10px auto;
            display: block;
            border: 3px solid #C85A3E;
        }
        
        .btn-secondary {
            background: white;
            color: #C85A3E;
            border: 2px solid #C85A3E;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover {
            background: #C85A3E;
            color: white;
        }
        
        .download-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 15px;
            background: white;
            border: 2px solid #22c55e;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: #166534;
        }
        
        .download-btn:hover {
            background: #22c55e;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }
        
        .download-btn:hover span {
            color: white;
        }
        
        .avery-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 12px 10px;
            background: white;
            border: 2px solid #d1d5db;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            color: #374151;
        }
        
        .avery-btn strong {
            color: #C85A3E;
            font-size: 13px;
        }
        
        .avery-btn span {
            color: #6b7280;
            font-size: 11px;
        }
        
        .avery-btn:hover {
            border-color: #C85A3E;
            background: #fff5f5;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(200, 90, 62, 0.15);
        }
        
        .product-data-item {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 15px;
            border: 2px solid #E8DDD6;
            transition: all 0.2s;
        }
        
        .product-data-item.selected {
            border-color: #C85A3E;
            background: #fffaf9;
            box-shadow: 0 2px 12px rgba(200, 90, 62, 0.1);
        }
        
        .qr-download-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: #374151;
            margin-top: 10px;
            transition: all 0.2s;
        }
        
        .qr-download-btn:hover {
            background: #C85A3E;
            color: white;
            border-color: #C85A3E;
        }
        /* Animated Thread Background */
        .thread-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
            opacity: 0.06;
        }

        .thread-line {
            position: absolute;
            height: 1px;
            background: #B08968;
            transform-origin: left center;
            animation: threadWeave 20s ease-in-out infinite;
        }

        .thread-line:nth-child(1) { top: 15%; width: 80%; left: -10%; animation-delay: 0s; }
        .thread-line:nth-child(2) { top: 35%; width: 90%; left: 5%; animation-delay: -4s; }
        .thread-line:nth-child(3) { top: 55%; width: 70%; left: -5%; animation-delay: -8s; }
        .thread-line:nth-child(4) { top: 75%; width: 85%; left: 10%; animation-delay: -12s; }
        .thread-line:nth-child(5) { top: 90%; width: 75%; left: -8%; animation-delay: -16s; }

        @keyframes threadWeave {
            0%, 100% { transform: rotate(0deg) scaleX(1); opacity: 0.3; }
            25% { transform: rotate(0.5deg) scaleX(1.05); opacity: 0.6; }
            50% { transform: rotate(-0.3deg) scaleX(0.95); opacity: 0.4; }
            75% { transform: rotate(0.4deg) scaleX(1.02); opacity: 0.7; }
        }
    </style>
</head>
<body>

<!-- Animated Thread Background -->
<div class="thread-bg">
    <div class="thread-line"></div>
    <div class="thread-line"></div>
    <div class="thread-line"></div>
    <div class="thread-line"></div>
    <div class="thread-line"></div>
</div>

    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo-header-content" onclick="showView('landing')">
                <span class="logo-symbol">Á∑£</span>
                <div class="logo-text-wrapper">
                    <span class="logo-text">DUY·ªÄN</span>
                    <span class="logo-tagline">Weaving the tapestry of life</span>
                </div>
            </div>
            <button class="cta-button" id="headerAboutBtn" style="background: none; color: #3D2E24; border: none; font-weight: 600;">About</button>
            <button class="cta-button" id="headerBtn" onclick="handleHeaderCTA()">Log In</button>
            <div class="user-menu" id="userMenu">
                <span class="user-email" id="userEmail"></span>
                <button class="cta-button" onclick="showView('mode')" style="background: white; color: #C85A3E; border: 2px solid #C85A3E;">+ New QR</button>
                <button class="cta-button" onclick="showView('myCodes')" style="background: #3D2E24; color: white;">My QR Codes <span id="qrCount" style="background: #C85A3E; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 4px;">0</span></button>
                <button class="cta-button" onclick="logout()" style="background: #FAF0EA; color: #7D6E64;">Log Out</button>
            </div>
        </div>
    </header>

    <!-- Landing Page View -->
    <div id="landingView" class="view active">
        <section class="hero">
            <span class="hero-symbol">Á∑£</span>
            <div class="hero-text">DUY·ªÄN</div>
            <p class="hero-tagline">Weaving the tapestry of life</p>
            
            <h1>Create QR Codes That Preserve What Matters</h1>
            
            <p class="hero-description">
                More than just a link. Duy·ªÅn QR codes connect physical moments to lasting digital memories. 
                Perfect for businesses who want to add meaning to their products, and individuals who want 
                to preserve the stories behind life's special moments.
            </p>
            
            <button class="btn-primary" onclick="handleHeaderCTA()">Start Creating</button>
        </section>
        
        
        <!-- Use Cases -->
        <section style="padding: 80px 40px; background: #FDF8F5;">
            <div style="max-width: 900px; margin: 0 auto; text-align: center;">
                <h2 style="font-family: 'Crimson Pro', Georgia, serif; font-size: 42px; margin-bottom: 20px;">Who Uses Duy√™n?</h2>
            </div>
            
            <div style="max-width: 1200px; margin: 40px auto 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px;">
                <div style="background: white; border-radius: 20px; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                    <div style="font-size: 48px; margin-bottom: 20px;">üåπ</div>
                    <h3 style="font-size: 24px; font-weight: 600; margin-bottom: 15px;">Florists & Gift Shops</h3>
                    <p style="color: #7D6E64; line-height: 1.7; margin-bottom: 15px;">
                        Include a QR code on gift cards. Recipients scan to watch a video of you arranging the bouquet, 
                        read the sender's message, and get care instructions.
                    </p>
                    <p style="font-style: italic; color: #C85A3E; font-size: 15px;">
                        "When the flowers fade, the memory doesn't."
                    </p>
                </div>
                
                <div style="background: white; border-radius: 20px; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                    <div style="font-size: 48px; margin-bottom: 20px;">üëï</div>
                    <h3 style="font-size: 24px; font-weight: 600; margin-bottom: 15px;">E-commerce & Fashion</h3>
                    <p style="color: #7D6E64; line-height: 1.7; margin-bottom: 15px;">
                        Add QR codes to product tags. Share your sustainability story, fabric origins, care guides, 
                        and repair services‚Äîmeeting California SB 707 requirements.
                    </p>
                    <p style="font-style: italic; color: #C85A3E; font-size: 15px;">
                        "Turn disposable fashion into cherished items with stories."
                    </p>
                </div>
                
                <div style="background: white; border-radius: 20px; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚òï</div>
                    <h3 style="font-size: 24px; font-weight: 600; margin-bottom: 15px;">Restaurants & Cafes</h3>
                    <p style="color: #7D6E64; line-height: 1.7; margin-bottom: 15px;">
                        Table QR codes that customers can save. They preserve the memory of a special date night, 
                        anniversary dinner, or coffee shop where they wrote their novel.
                    </p>
                    <p style="font-style: italic; color: #C85A3E; font-size: 15px;">
                        "Places become part of your story."
                    </p>
                </div>
                
                <div style="background: white; border-radius: 20px; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚úÇÔ∏è</div>
                    <h3 style="font-size: 24px; font-weight: 600; margin-bottom: 15px;">Service Providers</h3>
                    <p style="color: #7D6E64; line-height: 1.7; margin-bottom: 15px;">
                        Hair stylists, nail artists, photographers‚Äîgive clients a QR card with before/after photos, 
                        care tips, and your contact info for their next appointment.
                    </p>
                    <p style="font-style: italic; color: #C85A3E; font-size: 15px;">
                        "Stay connected beyond the appointment."
                    </p>
                </div>
                
                <div style="background: white; border-radius: 20px; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                    <div style="font-size: 48px; margin-bottom: 20px;">üé®</div>
                    <h3 style="font-size: 24px; font-weight: 600; margin-bottom: 15px;">Makers & Artisans</h3>
                    <p style="color: #7D6E64; line-height: 1.7; margin-bottom: 15px;">
                        Include QR codes with handmade items. Share your process, materials, story, and care instructions. 
                        Turn your craft into a cherished heirloom.
                    </p>
                    <p style="font-style: italic; color: #C85A3E; font-size: 15px;">
                        "Your story makes your work priceless."
                    </p>
                </div>
                
                <div style="background: white; border-radius: 20px; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                    <div style="font-size: 48px; margin-bottom: 20px;">üíù</div>
                    <h3 style="font-size: 24px; font-weight: 600; margin-bottom: 15px;">Individuals & Families</h3>
                    <p style="color: #7D6E64; line-height: 1.7; margin-bottom: 15px;">
                        Create memory cards for special gifts. Add photos, voice messages, and stories that the recipient 
                        can keep forever‚Äîlong after the physical gift is gone.
                    </p>
                    <p style="font-style: italic; color: #C85A3E; font-size: 15px;">
                        "Gifts become memories, memories become tapestries."
                    </p>
                </div>
            </div>
        </section>
        
        <!-- How It Works -->
        <section style="background: white; padding: 80px 40px;">
            <div style="max-width: 900px; margin: 0 auto;">
                <h2 style="font-family: 'Crimson Pro', Georgia, serif; font-size: 42px; text-align: center; margin-bottom: 50px;">How It Works</h2>
                
                <div style="display: grid; gap: 40px;">
                    <div style="display: flex; gap: 30px; align-items: flex-start;">
                        <div style="flex-shrink: 0; width: 60px; height: 60px; background: linear-gradient(135deg, #C85A3E 0%, #8B1538 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 600;">1</div>
                        <div>
                            <h3 style="font-size: 22px; margin-bottom: 10px;">Generate Your QR Code</h3>
                            <p style="color: #7D6E64; line-height: 1.8;">
                                Create a unique QR code in seconds. Customize with your colors, add your business name, 
                                and choose from Avery label templates for easy printing.
                            </p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 30px; align-items: flex-start;">
                        <div style="flex-shrink: 0; width: 60px; height: 60px; background: linear-gradient(135deg, #C85A3E 0%, #8B1538 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 600;">2</div>
                        <div>
                            <h3 style="font-size: 22px; margin-bottom: 10px;">Attach to Your Product or Card</h3>
                            <p style="color: #7D6E64; line-height: 1.8;">
                                Print on stickers, cards, tags, or packaging. Each QR code is unique and links to a 
                                beautiful landing page on duyen.io.
                            </p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 30px; align-items: flex-start;">
                        <div style="flex-shrink: 0; width: 60px; height: 60px; background: linear-gradient(135deg, #C85A3E 0%, #8B1538 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 600;">3</div>
                        <div>
                            <h3 style="font-size: 22px; margin-bottom: 10px;">Add Your Content</h3>
                            <p style="color: #7D6E64; line-height: 1.8;">
                                Upload photos, videos, messages, care instructions, or contact information. Create the 
                                experience you want recipients to discover.
                            </p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 30px; align-items: flex-start;">
                        <div style="flex-shrink: 0; width: 60px; height: 60px; background: linear-gradient(135deg, #C85A3E 0%, #8B1538 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 600;">4</div>
                        <div>
                            <h3 style="font-size: 22px; margin-bottom: 10px;">Recipient Scans & Saves</h3>
                            <p style="color: #7D6E64; line-height: 1.8;">
                                When someone scans your QR code, they see your beautiful story. They can save it to their 
                                personal Duy√™n archive‚Äîa private collection they can search and cherish forever.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Final CTA -->
        <section style="background: linear-gradient(135deg, #C85A3E 0%, #8B1538 100%); padding: 80px 40px; text-align: center; color: white;">
            <h2 style="font-family: 'Crimson Pro', Georgia, serif; font-size: 42px; margin-bottom: 20px;">Ready to Start Weaving?</h2>
            <p style="font-size: 20px; margin-bottom: 40px; opacity: 0.9;">Create your first Duy√™n QR code in less than 60 seconds</p>
            <button onclick="handleHeaderCTA()" style="background: white; color: #C85A3E; padding: 18px 48px; border-radius: 12px; border: none; font-weight: 600; font-size: 18px; cursor: pointer;">Create Your QR Code</button>
        </section>
        
        <!-- Footer -->
        <footer style="background: #3D2E24; color: rgba(255, 255, 255, 0.8); padding: 60px 40px 30px;">
            <div style="max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; margin-bottom: 40px;">
                <div>
                    <h3 style="color: white; margin-bottom: 20px; font-size: 18px;">Á∑£ DUY·ªÄN</h3>
                    <p>Weaving the tapestry of life</p>
                    <p style="margin-top: 20px;">
                        Creating meaningful connections through QR codes that preserve what matters.
                    </p>
                </div>
                
                <div>
                    <h3 style="color: white; margin-bottom: 20px; font-size: 18px;">For Businesses</h3>
                    <p style="margin-bottom: 10px; cursor: pointer;" onclick="handleHeaderCTA()">QR Generator</p>
                    <p style="margin-bottom: 10px;">Use Cases</p>
                    <p style="margin-bottom: 10px;">How It Works</p>
                </div>
                
                <div>
                    <h3 style="color: white; margin-bottom: 20px; font-size: 18px;">For Individuals</h3>
                    <p style="margin-bottom: 10px; cursor: pointer;" onclick="handleHeaderCTA()">Create Account</p>
                    <p style="margin-bottom: 10px;">My Tapestry</p>
                    <p style="margin-bottom: 10px; cursor: pointer;" onclick="handleHeaderCTA()">Generate QR Code</p>
                </div>
                
                <div>
                    <h3 style="color: white; margin-bottom: 20px; font-size: 18px;">Company</h3>
                    <p style="margin-bottom: 10px; cursor: pointer;" id="footerAboutLink">About Duy√™n</p>
                    <p style="margin-bottom: 10px;">Contact Us</p>
                    <p style="margin-bottom: 10px;">Privacy Policy</p>
                </div>
            </div>
            
            <div style="text-align: center; padding-top: 30px; border-top: 1px solid rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.5);">
                <p>&copy; 2026 Duy√™n. All rights reserved. ‚Ä¢ Made with care in California</p>
            </div>
        </footer>
    </div>

    <!-- Mode Selection View -->
    <div id="modeView" class="view">
        <div class="mode-selection">
            <h1 style="text-align: center; margin-bottom: 20px;">Choose Generation Mode</h1>
            
            <div class="mode-grid">
                <div class="mode-card" onclick="selectMode('single')">
                    <div class="mode-icon">üì±</div>
                    <h3 class="mode-title">Single QR Code</h3>
                    <p class="mode-description">
                        Generate one QR code at a time. Perfect for individual gifts, products, or special occasions.
                    </p>
                    <div class="mode-button">Create Single QR Code ‚Üí</div>
                </div>
                
                <div class="mode-card" onclick="selectMode('batch')">
                    <div class="mode-icon">üì¶</div>
                    <h3 class="mode-title">Batch QR Codes</h3>
                    <p class="mode-description">
                        Generate up to 50 QR codes at once. Ideal for businesses, events, or bulk production.
                    </p>
                    <div class="mode-button">Create Batch QR Codes ‚Üí</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generator View -->
    <div id="generatorView" class="view">
        <div class="generator">
            <h2 id="generatorTitle">QR Code Generator</h2>
            
            <div id="singleForm" style="display: none;">
                <div class="form-group">
                    <label>QR Code Label</label>
                    <input type="text" id="singleLabel" class="input-field" placeholder="e.g., Anniversary Gift">
                </div>
                
                <!-- Product Data Entry - Single Mode -->
                <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe8e0 100%); border-radius: 16px; padding: 30px; margin: 30px 0; border: 3px solid #C85A3E; box-shadow: 0 8px 20px rgba(200, 90, 62, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="font-size: 22px; font-weight: 700; color: #C85A3E; margin: 0;">üì¶ Product Data Upload</h4>
                        <span style="background: linear-gradient(135deg, #C85A3E 0%, #8B1538 100%); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 700; box-shadow: 0 4px 12px rgba(200, 90, 62, 0.3);">
                            ‚ú® Coming Soon: AI will extract info
                        </span>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #C85A3E;">
                        <p style="color: #3D2E24; font-size: 15px; margin: 0 0 10px 0; line-height: 1.7; font-weight: 500;">
                            üì∏ <strong>Upload product photo</strong> and add details.<br>
                            Recipients can scan the QR code to see this information.
                        </p>
                        <p style="color: #7D6E64; font-size: 14px; margin: 0; line-height: 1.6;">
                            üí° <strong>Tip:</strong> You can also leave this blank and let the recipient add data by scanning the QR code!
                        </p>
                    </div>
                    
                    <div id="singleProductData">
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; font-weight: 700; margin-bottom: 12px; font-size: 16px; color: #3D2E24;">üì∏ Upload Media <span style="font-weight: 400; font-size: 13px; color: #9A8478;">(Photos, Videos, Voice Memos)</span></label>
                            <div class="photo-upload-area" onclick="document.getElementById('media-single').click()">
                                <div id="preview-single">
                                    <div style="font-size: 60px; margin-bottom: 15px;">üì∑ üé•</div>
                                    <div style="color: #C85A3E; font-weight: 700; font-size: 16px; margin-bottom: 8px;">Click to upload media</div>
                                    <div style="color: #7D6E64; font-size: 14px;">Photos, videos, or audio files</div>
                                    <div style="color: #9A8478; font-size: 12px; margin-top: 8px;">JPG, PNG, MP4, MOV, MP3, WAV, M4A ‚Äî up to 25MB</div>
                                </div>
                            </div>
                            <input type="file" id="media-single" accept="image/*,video/*,audio/*" multiple style="display: none;" onchange="handleMediaUpload(event, 'single')">
                            
                            <!-- Voice Recorder -->
                            <div id="voiceRecorder-single" class="voice-recorder">
                                <button type="button" id="recBtn-single" class="rec-btn" onclick="toggleRecording('single')">
                                    <span id="recIcon-single" class="rec-icon">üé§</span>
                                    <span id="recLabel-single">Record Voice Memo</span>
                                </button>
                                <div id="recStatus-single" class="rec-status" style="display: none;">
                                    <div class="rec-pulse"></div>
                                    <span id="recTimer-single" style="font-weight: 600; color: #c53030;">0:00</span>
                                    <button type="button" onclick="stopRecording('single')" style="background: #c53030; color: white; border: none; padding: 6px 16px; border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer; margin-left: 10px;">‚èπ Stop</button>
                                </div>
                            </div>
                            
                            <div id="mediaList-single" style="margin-top: 10px;"></div>
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; font-weight: 700; margin-bottom: 12px; font-size: 16px; color: #3D2E24;">üìé Upload Files <span style="font-weight: 400; font-size: 13px; color: #9A8478;">(Documents, PDFs, etc.)</span></label>
                            <div class="file-upload-area" onclick="document.getElementById('files-single').click()">
                                <div id="filePreview-single">
                                    <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                                    <div style="color: #3D2E24; font-weight: 600;">Click to upload files</div>
                                    <div style="color: #9A8478; font-size: 12px; margin-top: 5px;">PDF, DOC, XLS, TXT, ZIP ‚Äî up to 10MB each</div>
                                </div>
                            </div>
                            <input type="file" id="files-single" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.csv,.zip,.rar" multiple style="display: none;" onchange="handleFileUpload(event, 'single')">
                            <div id="fileList-single" style="margin-top: 10px;"></div>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 700; margin-bottom: 12px; font-size: 16px; color: #3D2E24;">üìù Product Details</label>
                            <textarea id="details-single" class="input-field" rows="6" style="font-size: 15px;" placeholder="Example:

Premium Cotton T-Shirt
100% Organic Cotton
Machine wash cold, tumble dry low
Made in Portugal
$45

Add any product information here..."></textarea>
                            <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 3px solid #81B29A;">
                                <div style="font-size: 13px; color: #3D2E24; font-weight: 600; margin-bottom: 5px;">
                                    üîÑ Two Ways to Add Data:
                                </div>
                                <div style="font-size: 12px; color: #7D6E64; line-height: 1.6;">
                                    <strong>Option 1:</strong> Add now (upload photo + type details)<br>
                                    <strong>Option 2:</strong> Generate blank QR, then scan it to add data later
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="batchForm" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label>Number of QR Codes</label>
                        <input type="number" id="quantity" class="input-field" min="1" max="50" value="5" onchange="updateProductForms()">
                    </div>
                    <div class="form-group">
                        <label>Label Prefix</label>
                        <input type="text" id="prefix" class="input-field" placeholder="e.g., Card" onchange="updateProductForms()">
                    </div>
                </div>
                
                <!-- Product Data Entry -->
                <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe8e0 100%); border-radius: 16px; padding: 30px; margin: 30px 0; border: 3px solid #C85A3E; box-shadow: 0 8px 20px rgba(200, 90, 62, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="font-size: 22px; font-weight: 700; color: #C85A3E; margin: 0;">üì¶ Product Data Upload</h4>
                        <span style="background: linear-gradient(135deg, #C85A3E 0%, #8B1538 100%); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 700; box-shadow: 0 4px 12px rgba(200, 90, 62, 0.3);">
                            ‚ú® Coming Soon: AI will extract info
                        </span>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #C85A3E;">
                        <p style="color: #3D2E24; font-size: 15px; margin: 0 0 15px 0; line-height: 1.7; font-weight: 500;">
                            üì∏ <strong>Upload product photos</strong> and add details for each QR code.<br>
                            Recipients will see this information when they scan.
                        </p>
                        <div style="background: #e6f7ff; padding: 12px; border-radius: 8px; border-left: 3px solid #1890ff;">
                            <p style="color: #0050b3; font-size: 14px; margin: 0; font-weight: 600;">
                                üí° <strong>Optional:</strong> Leave blank and recipients can add their own data by scanning the QR codes!
                            </p>
                        </div>
                    </div>
                    
                    <div id="productDataForms" style="margin-top: 25px;"></div>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <button type="button" onclick="toggleProductData()" style="background: linear-gradient(135deg, #C85A3E 0%, #b04a2e 100%); color: white; border: none; padding: 16px 40px; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 16px; box-shadow: 0 4px 15px rgba(200, 90, 62, 0.4); transition: all 0.3s;">
                            <span id="toggleProductDataText">üìã Show Product Upload Forms</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Base URL</label>
                <input type="url" id="baseUrl" class="input-field" value="https://duyen.io/q/">
            </div>
            
            <!-- Color Selection -->
            <h3 style="font-size: 18px; font-weight: 600; margin-top: 40px; margin-bottom: 15px;">üé® QR Code Color</h3>
            
            <div class="color-section">
                <div class="color-presets" id="colorPresets"></div>
                
                <div class="color-input-group">
                    <input type="color" id="colorPicker" value="#C85A3E" onchange="updateCustomColor()">
                    <input type="text" id="hexInput" class="input-field" style="flex: 1;" value="#C85A3E" placeholder="#000000" onchange="updateFromHex()">
                </div>
            </div>
            
            <!-- Logo Option -->
            <h3 style="font-size: 18px; font-weight: 600; margin-top: 40px; margin-bottom: 15px;">Á∑£ Center Logo</h3>
            <div style="background: #f7fafc; padding: 20px; border-radius: 12px; border: 2px solid #E8DDD6;">
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                    <input type="checkbox" id="includeLogo" checked style="width: 20px; height: 20px; accent-color: #C85A3E;">
                    <span style="font-weight: 600;">Include Duy√™n logo (Á∑£) in QR code center</span>
                </label>
                <p style="color: #7D6E64; font-size: 13px; margin-top: 10px; margin-left: 32px;">
                    The logo adds brand recognition. QR codes use error correction so they still scan perfectly with the logo.
                </p>
            </div>
            
            <button class="btn-primary" onclick="generateQR()">üéØ Generate QR Code</button>
            <button class="btn-primary" onclick="showView('mode')" style="background: white; color: #C85A3E; border: 2px solid #C85A3E; margin-left: 15px;">‚Üê Change Mode</button>
            
            <div class="qr-result" id="qrResult" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 15px;">
                    <h3 style="margin: 0;">‚ú® Your QR Code(s)</h3>
                    <button type="button" onclick="showView('myCodes')" style="background: #3D2E24; color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer;">üìã View My QR Codes ‚Üí</button>
                </div>
                
                <!-- Download Options -->
                <div id="downloadSection" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 16px; padding: 25px; margin: 25px 0; border: 2px solid #22c55e;">
                    <h4 style="color: #166534; margin-bottom: 20px; font-size: 18px;">üì• Download Options</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <button onclick="downloadAllPNG()" class="download-btn" type="button">
                            <span style="font-size: 24px;">üñºÔ∏è</span>
                            <span>Download All as PNG</span>
                            <span style="font-size: 11px; color: #7D6E64;">Individual image files</span>
                        </button>
                        <button onclick="downloadPDF()" class="download-btn" type="button">
                            <span style="font-size: 24px;">üìÑ</span>
                            <span>Download as PDF</span>
                            <span style="font-size: 11px; color: #7D6E64;">All QR codes in one file</span>
                        </button>
                    </div>
                    
                    <h5 style="color: #166534; margin: 25px 0 15px; font-size: 16px; border-top: 1px solid #bbf7d0; padding-top: 20px;">üè∑Ô∏è Avery Label Templates</h5>
                    <p style="color: #7D6E64; font-size: 13px; margin-bottom: 15px;">Download PDF formatted for popular Avery label sheets - print at home!</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                        <button onclick="downloadAveryPDF('22806')" class="avery-btn" type="button">
                            <strong>Avery 22806</strong>
                            <span>2" √ó 2" Square</span>
                            <span>12 per sheet</span>
                        </button>
                        <button onclick="downloadAveryPDF('22565')" class="avery-btn" type="button">
                            <strong>Avery 22565</strong>
                            <span>1.5" √ó 1.5" Glossy</span>
                            <span>24 per sheet</span>
                        </button>
                        <button onclick="downloadAveryPDF('5371')" class="avery-btn" type="button">
                            <strong>Avery 5371</strong>
                            <span>2" √ó 3.5" Business Card</span>
                            <span>10 per sheet</span>
                        </button>
                        <button onclick="downloadAveryPDF('22807')" class="avery-btn" type="button">
                            <strong>Avery 22807</strong>
                            <span>2" Round</span>
                            <span>12 per sheet</span>
                        </button>
                        <button onclick="downloadAveryPDF('5163')" class="avery-btn" type="button">
                            <strong>Avery 5163</strong>
                            <span>2" √ó 4" Shipping</span>
                            <span>10 per sheet</span>
                        </button>
                        <button onclick="downloadAveryPDF('5160')" class="avery-btn" type="button">
                            <strong>Avery 5160</strong>
                            <span>1" √ó 2.625" Address</span>
                            <span>30 per sheet</span>
                        </button>
                        <button onclick="downloadAveryPDF('5164')" class="avery-btn" type="button">
                            <strong>Avery 5164</strong>
                            <span>3.33" √ó 4" Shipping</span>
                            <span>6 per sheet</span>
                        </button>
                    </div>
                    
                    <!-- Download Preview Area -->
                    <div id="downloadPreview" style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #bbf7d0; display: none;">
                        <h5 style="color: #166534; margin-bottom: 15px; font-size: 16px;">üìã Download Preview</h5>
                        <div id="previewContent" style="background: white; border-radius: 12px; padding: 20px; text-align: center;"></div>
                    </div>
                </div>
                
                <div class="qr-grid" id="qrGrid"></div>
            </div>
        </div>
    </div>

    <!-- My QR Codes View -->
    <div id="myCodesView" class="view">
        <div class="generator" style="max-width: 1000px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
                <div>
                    <h2 style="margin: 0; color: #3D2E24;">My QR Codes</h2>
                    <p style="color: #9A8478; margin: 5px 0 0; font-size: 14px;" id="myCodesSubtitle">0 codes created</p>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <input type="text" id="searchCodes" placeholder="Search labels..." oninput="renderMyCodes()" style="padding: 10px 16px; border: 2px solid #E8DDD6; border-radius: 10px; font-size: 14px; width: 200px;">
                    <select id="filterStatus" onchange="renderMyCodes()" style="padding: 10px 16px; border: 2px solid #E8DDD6; border-radius: 10px; font-size: 14px; cursor: pointer;">
                        <option value="all">All</option>
                        <option value="active">Active</option>
                        <option value="draft">Drafts</option>
                    </select>
                    <button type="button" id="batchEditToggle" class="btn-primary" style="background: #3D2E24;">‚úèÔ∏è Batch Edit</button>
                    <button class="btn-primary" onclick="showView('mode')">+ New QR Code</button>
                </div>
            </div>
            
            <div id="myCodesEmpty" style="text-align: center; padding: 60px 20px; display: none;">
                <div style="font-size: 64px; margin-bottom: 15px;">üì≠</div>
                <h3 style="color: #3D2E24; margin-bottom: 10px;">No QR Codes Yet</h3>
                <p style="color: #9A8478; margin-bottom: 25px;">Create your first QR code to get started.</p>
                <button class="btn-primary" onclick="showView('mode')">Create QR Code ‚Üí</button>
            </div>
            
            <!-- Batch Edit Selection Bar -->
            <div id="batchSelectBar" style="display: none; background: #3D2E24; color: white; padding: 14px 20px; border-radius: 12px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                            <input type="checkbox" id="batchSelectAll" style="width: 20px; height: 20px; accent-color: #C85A3E; cursor: pointer;">
                            <span style="font-weight: 600;">Select All</span>
                        </label>
                        <span id="batchSelectedCount" style="color: #ccc; font-size: 13px;">(0 selected)</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button type="button" id="batchEditBtn" style="background: #C85A3E; color: white; border: none; padding: 8px 18px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; opacity: 0.4; pointer-events: none;">‚úèÔ∏è Edit Selected</button>
                        <button type="button" id="batchDeleteBtn" style="background: #fed7d7; color: #c53030; border: none; padding: 8px 18px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; opacity: 0.4; pointer-events: none;">üóëÔ∏è Delete Selected</button>
                        <button type="button" id="batchCancelBtn" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 18px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer;">‚úï Cancel</button>
                    </div>
                </div>
            </div>
            
            <!-- Batch Edit Panel - Simple Design -->
            <div id="batchEditPanel" style="display: none; background: white; border: 2px solid #C85A3E; border-radius: 16px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(196,30,58,0.15);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h3 style="margin: 0; color: #C85A3E;">‚úèÔ∏è Batch Edit ‚Äî <span id="batchEditCount">0</span> QR Codes</h3>
                    <span style="font-size: 24px; cursor: pointer; color: #9A8478;" onclick="batchHideEditPanel()">‚úï</span>
                </div>
                <p style="color: #888; font-size: 13px; margin-bottom: 20px;">Fill in what you want to change. Empty fields will be skipped.</p>
                
                <!-- Details -->
                <div style="margin-bottom: 18px;">
                    <label style="display: block; font-weight: 700; font-size: 14px; color: #3D2E24; margin-bottom: 6px;">üìù Details / Message</label>
                    <textarea id="batchDetails" class="input-field" rows="3" placeholder="Leave blank to keep existing..."></textarea>
                </div>
                
                <!-- Color -->
                <div style="margin-bottom: 18px;">
                    <label style="display: block; font-weight: 700; font-size: 14px; color: #3D2E24; margin-bottom: 6px;">üé® QR Code Color</label>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input type="color" id="batchColor" value="#C85A3E" style="width: 50px; height: 40px; border: none; cursor: pointer; border-radius: 8px;" oninput="document.getElementById('batchColorHex').value = this.value">
                        <input type="text" id="batchColorHex" class="input-field" value="#C85A3E" style="width: 100px;" oninput="document.getElementById('batchColor').value = this.value">
                        <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #7D6E64; cursor: pointer; user-select: none;">
                            <input type="checkbox" id="batchColorApply" style="width: 16px; height: 16px;"> Apply color
                        </label>
                    </div>
                </div>
                
                <!-- Media -->
                <div style="margin-bottom: 18px;">
                    <label style="display: block; font-weight: 700; font-size: 14px; color: #3D2E24; margin-bottom: 6px;">üì∏ Media <span style="font-weight: 400; color: #9A8478; font-size: 12px;">(replaces existing)</span></label>
                    <div class="photo-upload-area" onclick="document.getElementById('media-batch').click()" style="padding: 16px;">
                        <div id="preview-batch">
                            <div style="font-size: 30px; margin-bottom: 4px;">üì∑ üé•</div>
                            <div style="color: #C85A3E; font-weight: 600; font-size: 13px;">Click to upload media</div>
                        </div>
                    </div>
                    <input type="file" id="media-batch" accept="image/*,video/*,audio/*" multiple style="display: none;" onchange="handleMediaUpload(event, 'batch')">
                    <div class="voice-recorder" id="voiceRecorder-batch" style="margin-top: 6px;">
                        <button type="button" id="recBtn-batch" class="rec-btn" onclick="toggleRecording('batch')" style="padding: 7px 14px; font-size: 12px;">
                            <span id="recIcon-batch">üé§</span>
                            <span id="recLabel-batch">Record</span>
                        </button>
                        <div id="recStatus-batch" class="rec-status" style="display: none;">
                            <div class="rec-pulse"></div>
                            <span id="recTimer-batch" style="font-weight: 600; color: #c53030;">0:00</span>
                            <button type="button" onclick="stopRecording('batch')" style="background: #c53030; color: white; border: none; padding: 5px 12px; border-radius: 6px; font-weight: 600; font-size: 12px; cursor: pointer; margin-left: 8px;">‚èπ Stop</button>
                        </div>
                    </div>
                    <div id="mediaList-batch" style="margin-top: 6px;"></div>
                </div>
                
                <!-- Files -->
                <div style="margin-bottom: 18px;">
                    <label style="display: block; font-weight: 700; font-size: 14px; color: #3D2E24; margin-bottom: 6px;">üìé Files <span style="font-weight: 400; color: #9A8478; font-size: 12px;">(replaces existing)</span></label>
                    <div class="file-upload-area" onclick="document.getElementById('files-batch').click()" style="padding: 16px;">
                        <div id="filePreview-batch">
                            <div style="font-size: 28px; margin-bottom: 4px;">üìÅ</div>
                            <div style="color: #3D2E24; font-weight: 600; font-size: 13px;">Click to upload files</div>
                        </div>
                    </div>
                    <input type="file" id="files-batch" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.csv,.zip,.rar" multiple style="display: none;" onchange="handleFileUpload(event, 'batch')">
                    <div id="fileList-batch" style="margin-top: 6px;"></div>
                </div>
                
                <!-- Apply -->
                <div style="margin-top: 25px; display: flex; gap: 12px;">
                    <button class="btn-primary" id="batchApplyBtn" onclick="batchApplyEdits()" style="flex: 1; font-size: 16px; padding: 16px;">üöÄ Apply to <span id="batchApplyCount">0</span> QR Codes</button>
                    <button type="button" onclick="batchHideEditPanel()" style="background: #FAF0EA; color: #7D6E64; border: none; padding: 16px 24px; border-radius: 12px; font-weight: 600; cursor: pointer;">Cancel</button>
                </div>
            </div>
            
            <div id="myCodesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;"></div>
        </div>
    </div>

    <!-- About View -->
    <div id="aboutView" class="view">
        <div style="max-width: 800px; margin: 0 auto; padding: 60px 40px;">
            <button type="button" id="aboutBackBtn" style="background: none; border: none; color: #C85A3E; font-weight: 600; font-size: 15px; cursor: pointer; margin-bottom: 30px;">‚Üê Back</button>
            
            <h2 style="font-family: 'Crimson Pro', Georgia, serif; font-size: 42px; text-align: center; margin-bottom: 40px; color: #3D2E24;">About Duy√™n</h2>
            
            <p style="font-size: 18px; color: #555; line-height: 2; margin-bottom: 25px;">
                Duy√™n was born in the quiet moments between destinations. While driving for Lyft during the pandemic, my passengers carried flowers, gifts, wrapped boxes ‚Äî proof that someone, somewhere, was thinking of someone else. Bouquets to anniversaries. Care packages to new parents. A single rose to a doorstep in Oakland.
            </p>
            
            <p style="font-size: 18px; color: #555; line-height: 2; margin-bottom: 25px;">
                Every ride, I watched love show up. And every ride, I watched it disappear. The flowers wilted. The cards got lost. The love was real ‚Äî why does the evidence have to be temporary?
            </p>
            
            <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe8e0 100%); border-left: 4px solid #C85A3E; padding: 30px; border-radius: 12px; margin: 40px 0;">
                <p style="color: #3D2E24; font-size: 18px; line-height: 1.9; margin: 0;">
                    In Vietnamese, <strong style="color: #C85A3E;">duy√™n</strong> is the invisible thread that explains why certain people, places, and things enter your life and stay. Not quite fate, not quite chance. The reason your grandmother's ring feels like more than gold. Why a stranger's kindness, years later, still sits warm in your chest.
                </p>
            </div>
            
            <p style="font-size: 18px; color: #555; line-height: 2; margin-bottom: 25px;">
                That is why Duy√™n exists. We give meaningful connections a place to live.
            </p>
            
            <p style="font-size: 18px; color: #555; line-height: 2; margin-bottom: 25px;">
                Scan a card tucked into a bouquet and you don't just see who sent it ‚Äî you hear their voice, read their message, save the moment. Scan a tag on a handmade jacket and you see where it was made, who made it, how to repair it. Add your own photos, your own memories. When it wears out, you don't throw it away ‚Äî the pattern lives, the story continues.
            </p>
            
            <p style="font-size: 18px; color: #555; line-height: 2; margin-bottom: 25px;">
                Every moment you save becomes another thread. We're building it all for your life tapestry ‚Äî woven from the people, places, and things that made you who you are.
            </p>
            
            <p style="font-size: 20px; color: #3D2E24; line-height: 2; text-align: center; margin-top: 40px; font-style: italic;">
                Not everything is chance. Some things are meant to be woven in.<br>
                <strong style="color: #C85A3E;">Duy√™n is where they stay.</strong>
            </p>
            
            <p style="text-align: right; margin-top: 40px; font-size: 16px; color: #3D2E24;">
                ‚Äî <strong>Trinh Dao</strong><br>
                <span style="color: #9A8478; font-size: 14px;">Founder, Duy√™n</span>
            </p>
        </div>
    </div>

    <!-- Edit QR View -->
    <div id="editQRView" class="view">
        <div class="generator" style="max-width: 800px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <button type="button" onclick="showView('myCodes')" style="background: none; border: none; color: #C85A3E; font-weight: 600; font-size: 15px; cursor: pointer;">‚Üê Back to My QR Codes</button>
                <span id="editQRStatus" style="padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;"></span>
            </div>
            
            <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                <!-- QR Preview Column -->
                <div style="flex: 0 0 200px; text-align: center;">
                    <div id="editQRPreview" style="background: white; border: 2px solid #E8DDD6; border-radius: 16px; padding: 20px; margin-bottom: 15px;"></div>
                    <div id="editQRLabel" style="font-weight: 700; font-size: 18px; color: #3D2E24;"></div>
                    <div id="editQRUrl" style="font-size: 11px; color: #9A8478; margin-top: 5px; word-break: break-all;"></div>
                    <div id="editQRDate" style="font-size: 12px; color: #B08968; margin-top: 8px;"></div>
                </div>
                
                <!-- Edit Form Column -->
                <div style="flex: 1; min-width: 300px;">
                    <h2 id="editQRTitle" style="margin: 0 0 20px; color: #3D2E24;">Edit QR Code</h2>
                    
                    <div class="form-group">
                        <label>Label</label>
                        <input type="text" id="editLabel" class="input-field" placeholder="QR Code label">
                    </div>
                    
                    <!-- Media -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 10px; font-size: 15px; color: #3D2E24;">üì∏ Media</label>
                        <div class="photo-upload-area" onclick="document.getElementById('media-edit').click()" style="padding: 25px;">
                            <div id="preview-edit">
                                <div style="font-size: 36px; margin-bottom: 8px;">üì∑ üé•</div>
                                <div style="color: #C85A3E; font-weight: 600;">Click to add media</div>
                                <div style="color: #9A8478; font-size: 12px;">Photos, videos, audio</div>
                            </div>
                        </div>
                        <input type="file" id="media-edit" accept="image/*,video/*,audio/*" multiple style="display: none;" onchange="handleMediaUpload(event, 'edit')">
                        <div class="voice-recorder" id="voiceRecorder-edit" style="margin-top: 8px;">
                            <button type="button" id="recBtn-edit" class="rec-btn" onclick="toggleRecording('edit')" style="padding: 8px 16px; font-size: 13px;">
                                <span id="recIcon-edit">üé§</span>
                                <span id="recLabel-edit">Record</span>
                            </button>
                            <div id="recStatus-edit" class="rec-status" style="display: none;">
                                <div class="rec-pulse"></div>
                                <span id="recTimer-edit" style="font-weight: 600; color: #c53030;">0:00</span>
                                <button type="button" onclick="stopRecording('edit')" style="background: #c53030; color: white; border: none; padding: 5px 12px; border-radius: 6px; font-weight: 600; font-size: 12px; cursor: pointer; margin-left: 8px;">‚èπ Stop</button>
                            </div>
                        </div>
                        <div id="mediaList-edit" style="margin-top: 8px;"></div>
                    </div>
                    
                    <!-- Files -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 10px; font-size: 15px; color: #3D2E24;">üìé Files</label>
                        <div class="file-upload-area" onclick="document.getElementById('files-edit').click()" style="padding: 20px;">
                            <div id="filePreview-edit">
                                <div style="font-size: 32px; margin-bottom: 6px;">üìÅ</div>
                                <div style="color: #3D2E24; font-weight: 600; font-size: 14px;">Click to add files</div>
                            </div>
                        </div>
                        <input type="file" id="files-edit" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.csv,.zip,.rar" multiple style="display: none;" onchange="handleFileUpload(event, 'edit')">
                        <div id="fileList-edit" style="margin-top: 8px;"></div>
                    </div>
                    
                    <!-- Details -->
                    <div class="form-group">
                        <label>Product Details / Message</label>
                        <textarea id="editDetails" class="input-field" rows="5" placeholder="Product details, care instructions, message..."></textarea>
                    </div>
                    
                    <!-- Color -->
                    <div class="form-group">
                        <label>QR Code Color</label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <input type="color" id="editColor" value="#C85A3E" style="width: 50px; height: 40px; border: none; cursor: pointer; border-radius: 8px;" oninput="document.getElementById('editColorHex').value = this.value">
                            <input type="text" id="editColorHex" class="input-field" value="#C85A3E" style="width: 100px;" oninput="document.getElementById('editColor').value = this.value">
                        </div>
                    </div>
                    
                    <!-- Batch Apply All (shown when batch selection active) -->
                    <div id="editApplyAllDiv" style="display: none; margin-top: 20px;"></div>
                    
                    <!-- Actions -->
                    <div style="display: flex; gap: 12px; margin-top: 25px; flex-wrap: wrap;">
                        <button class="btn-primary" onclick="saveQREdits()" style="flex: 1;">üíæ Save Changes</button>
                        <button class="btn-primary" onclick="downloadEditQR()" style="flex: 1; background: #22c55e;">‚¨áÔ∏è Download PNG</button>
                        <button type="button" onclick="deleteQRCode()" style="flex: 0 0 auto; background: #fed7d7; color: #c53030; border: none; padding: 15px 20px; border-radius: 12px; font-weight: 600; cursor: pointer;">üóëÔ∏è Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Viewer Modal -->
    <div id="dataViewerModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; overflow-y: auto; padding: 20px;">
        <div style="max-width: 600px; margin: 40px auto; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 18px 24px; background: linear-gradient(135deg, #C85A3E 0%, #8B1538 100%); color: white;">
                <h3 id="dataViewerTitle" style="margin: 0; font-size: 18px;">Attached Data</h3>
                <button type="button" id="dataViewerClose" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; font-size: 18px; cursor: pointer; font-weight: bold;">‚úï</button>
            </div>
            <div id="dataViewerContent" style="padding: 24px;"></div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-container" style="position: relative;">
            <button type="button" id="authModalClose" style="position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 24px; color: #9A8478; cursor: pointer; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50; transition: color 0.2s;">‚úï</button>
            <div class="auth-logo">
                <span class="symbol">Á∑£</span>
                <span class="text">DUY·ªÄN</span>
            </div>
            
            <div id="signupForm">
                <h2 class="auth-title">Create Your Account</h2>
                <p class="auth-subtitle">Start weaving your tapestry of memories</p>

                <button class="btn-social" onclick="handleGoogleAuth()">
                    <span style="font-size: 1.3rem;">üîµ</span> Continue with Google
                </button>
                <button class="btn-social" onclick="handleAppleAuth()">
                    <span style="font-size: 1.3rem;">üçé</span> Continue with Apple
                </button>

                <div class="auth-divider">or sign up with email</div>
                
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="signupName" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="signupEmail" placeholder="you@example.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="signupPassword" placeholder="Create a password" minlength="6">
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="signupPasswordConfirm" placeholder="Re-enter your password" minlength="6" oninput="checkPasswordMatch()">
                    <div id="passwordMatch" style="font-size: 13px; margin-top: 5px; display: none;"></div>
                </div>
                
                <button class="btn-auth" onclick="signup()">Create Account</button>
                
                <div class="auth-toggle">
                    Already have an account? <button onclick="toggleAuth()">Log In</button>
                </div>
            </div>
            
            <div id="loginForm" style="display: none;">
                <h2 class="auth-title">Welcome Back</h2>
                <p class="auth-subtitle">Continue weaving your tapestry</p>

                <button class="btn-social" onclick="handleGoogleAuth()">
                    <span style="font-size: 1.3rem;">üîµ</span> Continue with Google
                </button>
                <button class="btn-social" onclick="handleAppleAuth()">
                    <span style="font-size: 1.3rem;">üçé</span> Continue with Apple
                </button>

                <div class="auth-divider">or log in with email</div>
                
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="loginEmail">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword">
                </div>
                
                <button class="btn-auth" onclick="login()">Log In</button>
                
                <div class="auth-toggle">
                    Don't have an account? <button onclick="toggleAuth()">Sign Up</button>
                </div>
            </div>
            
            <div id="verifyForm" style="display: none;">
                <h2 class="auth-title">Check Your Email</h2>
                <p class="auth-subtitle">We sent a verification link to <strong id="verifyEmail"></strong></p>
                
                <div style="text-align: center; margin: 30px 0; font-size: 60px;">üìß</div>
                
                <div class="verification-box">
                    <p>üìß DEMO MODE - Click below to verify</p>
                    <button onclick="verify()">‚úì Click to Verify Email</button>
                </div>
                
                <div class="auth-toggle">
                    Wrong email? <button onclick="backToSignup()">‚Üê Back to Sign Up</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Safely get jsPDF - will be undefined if library fails to load
        let jsPDF;
        try {
            jsPDF = window.jspdf ? window.jspdf.jsPDF : null;
        } catch(e) {
            console.warn('jsPDF not available:', e);
            jsPDF = null;
        }
        
        let currentUser = null;
        let currentMode = null;
        let selectedColor = '#C85A3E';
        let generatedQRCodes = []; // Store generated QR data for downloads
        let savedQRCodes = []; // Persistent library of all created QR codes
        let editingQRIndex = null; // Index of QR being edited
        let batchEditMode = false; // Whether batch selection mode is active
        let batchSelectedIndices = new Set(); // Set of selected savedQRCodes indices
        
        // Avery template specifications (in inches, converted to PDF points: 1 inch = 72 points)
        const averyTemplates = {
            '22806': { // 2x2 Square Labels
                name: 'Avery 22806 - 2" Square Labels',
                cols: 3, rows: 4, perSheet: 12,
                labelW: 2, labelH: 2,
                marginLeft: 0.3125, marginTop: 0.75,
                gapX: 0.25, gapY: 0
            },
            '22565': { // 1.5x1.5 Print-to-Edge Square Labels (Glossy)
                name: 'Avery 22565 - 1.5" Square (Print-to-Edge)',
                cols: 4, rows: 6, perSheet: 24,
                labelW: 1.5, labelH: 1.5,
                marginLeft: 0.875, marginTop: 0.625,
                gapX: 0.3125, gapY: 0.1875
            },
            '5371': { // Business Cards
                name: 'Avery 5371 - Business Cards',
                cols: 2, rows: 5, perSheet: 10,
                labelW: 3.5, labelH: 2,
                marginLeft: 0.75, marginTop: 0.5,
                gapX: 0, gapY: 0
            },
            '22807': { // 2" Round Labels
                name: 'Avery 22807 - 2" Round Labels',
                cols: 3, rows: 4, perSheet: 12,
                labelW: 2, labelH: 2,
                marginLeft: 0.4375, marginTop: 0.5,
                gapX: 0.375, gapY: 0,
                round: true
            },
            '5163': { // 2x4 Shipping
                name: 'Avery 5163 - 2"x4" Shipping Labels',
                cols: 2, rows: 5, perSheet: 10,
                labelW: 4, labelH: 2,
                marginLeft: 0.15625, marginTop: 0.5,
                gapX: 0.1875, gapY: 0
            },
            '5160': { // Address Labels
                name: 'Avery 5160 - Address Labels',
                cols: 3, rows: 10, perSheet: 30,
                labelW: 2.625, labelH: 1,
                marginLeft: 0.1875, marginTop: 0.5,
                gapX: 0.125, gapY: 0
            },
            '5164': { // Large Shipping
                name: 'Avery 5164 - 3.33"x4" Shipping Labels',
                cols: 2, rows: 3, perSheet: 6,
                labelW: 4, labelH: 3.333,
                marginLeft: 0.15625, marginTop: 0.5,
                gapX: 0.1875, gapY: 0
            }
        };
        
        // Color presets
        const colorPresets = [
            '#C85A3E', // burgundy (default - Duy·ªÅn red)
            '#000000', // black
            '#1a202c', // dark gray
            '#3D2E24', // slate
            '#3182ce', // blue
            '#81B29A', // green
            '#dd6b20', // orange
            '#9f7aea', // purple
            '#e53e3e', // red
            '#d69e2e'  // gold
        ];
        
        function showView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(view + 'View').classList.add('active');
            if (view === 'myCodes') renderMyCodes();
        }
        
        function handleHeaderCTA() {
            if (currentUser) {
                showView('mode');
            } else {
                document.getElementById('signupForm').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('verifyForm').style.display = 'none';
                document.getElementById('authModal').classList.add('active');
            }
        }
        
        function handleGoogleAuth() {
            console.log('üîµ Google auth');
            // In production: Supabase signInWithOAuth({ provider: 'google' })
            document.getElementById('authModal').classList.remove('active');
            currentUser = { email: 'user@gmail.com', name: 'Google User' };
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('headerBtn').style.display = 'none';
            if (document.getElementById('headerAboutBtn')) document.getElementById('headerAboutBtn').style.display = 'none';
            document.getElementById('userMenu').classList.add('active');
            showView('mode');
        }

        function handleAppleAuth() {
            console.log('üçé Apple auth');
            // In production: Supabase signInWithOAuth({ provider: 'apple' })
            document.getElementById('authModal').classList.remove('active');
            currentUser = { email: 'user@icloud.com', name: 'Apple User' };
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('headerBtn').style.display = 'none';
            if (document.getElementById('headerAboutBtn')) document.getElementById('headerAboutBtn').style.display = 'none';
            document.getElementById('userMenu').classList.add('active');
            showView('mode');
        }

        function toggleAuth() {
            const signup = document.getElementById('signupForm');
            const login = document.getElementById('loginForm');
            if (signup.style.display === 'none') {
                signup.style.display = 'block';
                login.style.display = 'none';
            } else {
                signup.style.display = 'none';
                login.style.display = 'block';
            }
        }
        
        function signup() {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupPasswordConfirm').value;
            
            if (!name || !email || !password || !confirmPassword) {
                alert('‚ùå Please fill in all fields');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('‚ùå Passwords do not match. Please try again.');
                document.getElementById('signupPasswordConfirm').value = '';
                return;
            }
            
            document.getElementById('verifyEmail').textContent = email;
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('verifyForm').style.display = 'block';
        }
        
        function checkPasswordMatch() {
            const password = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('signupPasswordConfirm').value;
            const matchDiv = document.getElementById('passwordMatch');
            
            if (confirm.length > 0) {
                matchDiv.style.display = 'block';
                if (password === confirm) {
                    matchDiv.innerHTML = '<span style="color: #81B29A;">‚úì Passwords match</span>';
                } else {
                    matchDiv.innerHTML = '<span style="color: #e53e3e;">‚úó Passwords do not match</span>';
                }
            } else {
                matchDiv.style.display = 'none';
            }
        }
        
        // Product data storage
        let productDataStore = {};
        let productDataVisible = false;
        
        function toggleProductData() {
            const forms = document.getElementById('productDataForms');
            const toggleText = document.getElementById('toggleProductDataText');
            
            productDataVisible = !productDataVisible;
            
            if (productDataVisible) {
                const quantity = parseInt(document.getElementById('quantity').value) || 1;
                renderProductForms(quantity);
                forms.style.display = 'block';
                toggleText.textContent = 'üìã Hide Product Upload Forms';
            } else {
                forms.style.display = 'none';
                toggleText.textContent = 'üìã Show Product Upload Forms';
            }
        }
        
        function updateProductForms() {
            if (productDataVisible) {
                const quantity = parseInt(document.getElementById('quantity').value) || 1;
                renderProductForms(quantity);
            }
        }
        
        function renderProductForms(count) {
            const container = document.getElementById('productDataForms');
            container.innerHTML = '';
            
            // Add "Apply #1 to All" toolbar (only if more than 1 form)
            if (count > 1) {
                const toolbar = document.createElement('div');
                toolbar.id = 'batchToolbar';
                toolbar.style.cssText = 'background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #22c55e; border-radius: 12px; padding: 18px 20px; margin-bottom: 20px;';
                toolbar.innerHTML = 
                    '<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">' +
                        '<div style="font-size: 14px; color: #166534;">' +
                            '<strong>üí° Tip:</strong> Fill in QR Code #1, then click the button to copy it to all others.' +
                        '</div>' +
                        '<button type="button" id="applyToAllBtn" onclick="applyFirstToAll()" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer; box-shadow: 0 4px 12px rgba(34,197,94,0.3); transition: all 0.3s; white-space: nowrap;">' +
                            'üìã Apply #1 to All (' + (count - 1) + ')' +
                        '</button>' +
                    '</div>' +
                    '<div id="applyStatus" style="display: none; margin-top: 10px; padding: 10px; background: white; border-radius: 8px; color: #166534; font-weight: 600; text-align: center;"></div>';
                container.appendChild(toolbar);
            }
            
            for (let i = 1; i <= count; i++) {
                const form = document.createElement('div');
                form.className = 'product-data-item';
                form.id = 'productForm-' + i;
                
                const badgeHTML = i === 1 && count > 1 
                    ? '<span style="background: #22c55e; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">SOURCE</span>'
                    : '<span style="color: #9A8478; font-size: 13px;">Optional</span>';
                
                form.innerHTML = 
                    '<div class="product-data-header">' +
                        '<h5>QR Code #' + i + '</h5>' +
                        badgeHTML +
                    '</div>' +
                    '<div class="photo-upload-area" onclick="document.getElementById(\'media-' + i + '\').click()">' +
                        '<div id="preview-' + i + '">' +
                            '<div style="font-size: 40px; margin-bottom: 8px;">üì∑ üé•</div>' +
                            '<div style="color: #C85A3E; font-weight: 600;">Upload media</div>' +
                            '<div style="color: #9A8478; font-size: 12px; margin-top: 4px;">Photos, videos, or audio files ‚Äî up to 25MB</div>' +
                        '</div>' +
                        '<input type="file" id="media-' + i + '" accept="image/*,video/*,audio/*" multiple style="display: none;" onchange="handleMediaUpload(event, ' + i + ')">' +
                    '</div>' +
                    '<div class="voice-recorder" id="voiceRecorder-' + i + '">' +
                        '<button type="button" id="recBtn-' + i + '" class="rec-btn" onclick="toggleRecording(' + i + ')">' +
                            '<span id="recIcon-' + i + '" class="rec-icon">üé§</span>' +
                            '<span id="recLabel-' + i + '">Record Voice Memo</span>' +
                        '</button>' +
                        '<div id="recStatus-' + i + '" class="rec-status" style="display: none;">' +
                            '<div class="rec-pulse"></div>' +
                            '<span id="recTimer-' + i + '" style="font-weight: 600; color: #c53030;">0:00</span>' +
                            '<button type="button" onclick="stopRecording(' + i + ')" style="background: #c53030; color: white; border: none; padding: 6px 16px; border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer; margin-left: 10px;">‚èπ Stop</button>' +
                        '</div>' +
                    '</div>' +
                    '<div id="mediaList-' + i + '" style="margin-bottom: 10px;"></div>' +
                    '<div class="file-upload-area" onclick="document.getElementById(\'files-' + i + '\').click()">' +
                        '<div id="filePreview-' + i + '">' +
                            '<div style="font-size: 36px; margin-bottom: 8px;">üìÅ</div>' +
                            '<div style="color: #3D2E24; font-weight: 600;">Upload files</div>' +
                            '<div style="color: #9A8478; font-size: 12px; margin-top: 4px;">PDF, DOC, XLS, TXT, ZIP ‚Äî up to 10MB each</div>' +
                        '</div>' +
                        '<input type="file" id="files-' + i + '" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.csv,.zip,.rar" multiple style="display: none;" onchange="handleFileUpload(event, ' + i + ')">' +
                    '</div>' +
                    '<div id="fileList-' + i + '" style="margin-bottom: 10px;"></div>' +
                    '<textarea id="details-' + i + '" placeholder="Product details, care instructions, message..." style="width: 100%; padding: 15px; border: 2px solid #E8DDD6; border-radius: 12px; min-height: 100px; font-family: inherit; font-size: 14px; resize: vertical;"></textarea>';
                container.appendChild(form);
            }
        }
        
        function applyFirstToAll() {
            var sourceDetailsEl = document.getElementById('details-1');
            var sourceDetailsVal = sourceDetailsEl ? sourceDetailsEl.value : '';
            var sourceData = productDataStore[1] || {};
            var hasMedia = sourceData.media && sourceData.media.length > 0;
            var hasFiles = sourceData.files && sourceData.files.length > 0;
            var hasPhoto = sourceData.photo;
            
            if (!sourceDetailsVal && !hasMedia && !hasFiles && !hasPhoto) {
                alert('‚ö†Ô∏è QR Code #1 is empty. Add media, files, or details to #1 first, then click Apply.');
                return;
            }
            
            var quantity = parseInt(document.getElementById('quantity').value) || 1;
            var copiedCount = 0;
            
            for (var i = 2; i <= quantity; i++) {
                // Copy details text
                if (sourceDetailsVal) {
                    var targetDetails = document.getElementById('details-' + i);
                    if (targetDetails) targetDetails.value = sourceDetailsVal;
                }
                
                // Copy all media and files
                productDataStore[i] = productDataStore[i] || {};
                if (hasPhoto) productDataStore[i].photo = sourceData.photo;
                if (sourceData.filename) productDataStore[i].filename = sourceData.filename;
                if (hasMedia) {
                    productDataStore[i].media = sourceData.media.slice();
                    renderMediaList(i);
                }
                if (hasFiles) {
                    productDataStore[i].files = sourceData.files.slice();
                    renderFileList(i);
                }
                
                // Update media preview
                if (hasMedia || hasPhoto) {
                    var preview = document.getElementById('preview-' + i);
                    if (preview) {
                        var count = (sourceData.media ? sourceData.media.length : 0) + (hasPhoto ? 1 : 0);
                        preview.innerHTML = 
                            '<div style="color: #81B29A; font-weight: 600; font-size: 14px;">‚úì ' + count + ' media item' + (count > 1 ? 's' : '') + ' copied from #1</div>' +
                            '<div style="color: #9A8478; font-size: 13px;">Click to add more</div>';
                    }
                }
                
                // Visual highlight
                var formEl = document.getElementById('productForm-' + i);
                if (formEl) {
                    formEl.classList.add('selected');
                    formEl.style.borderColor = '#22c55e';
                }
                
                copiedCount++;
            }
            
            // Show status
            var statusEl = document.getElementById('applyStatus');
            if (statusEl) {
                statusEl.style.display = 'block';
                statusEl.textContent = '‚úÖ Copied photo & details from #1 to ' + copiedCount + ' item' + (copiedCount > 1 ? 's' : '') + '!';
                setTimeout(function() { statusEl.style.display = 'none'; }, 4000);
            }
        }
        
        function handleMediaUpload(event, index) {
            var files = event.target.files;
            if (!files || files.length === 0) return;
            
            productDataStore[index] = productDataStore[index] || {};
            productDataStore[index].media = productDataStore[index].media || [];
            
            var firstImageSet = false;
            
            for (var f = 0; f < files.length; f++) {
                var file = files[f];
                if (file.size > 25 * 1024 * 1024) {
                    alert('‚ùå "' + file.name + '" is too large. Max 25MB per media file.');
                    continue;
                }
                
                (function(file) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var type = 'unknown';
                        if (file.type.startsWith('image/')) type = 'image';
                        else if (file.type.startsWith('video/')) type = 'video';
                        else if (file.type.startsWith('audio/')) type = 'audio';
                        
                        var mediaItem = {
                            name: file.name,
                            type: type,
                            mimeType: file.type,
                            size: file.size,
                            data: e.target.result
                        };
                        
                        productDataStore[index].media.push(mediaItem);
                        
                        // Set first image as the photo for QR display
                        if (type === 'image' && !productDataStore[index].photo) {
                            productDataStore[index].photo = e.target.result;
                            productDataStore[index].filename = file.name;
                        }
                        
                        renderMediaList(index);
                        updateMediaPreview(index);
                    };
                    reader.readAsDataURL(file);
                })(file);
            }
        }
        
        function handleFileUpload(event, index) {
            var files = event.target.files;
            if (!files || files.length === 0) return;
            
            productDataStore[index] = productDataStore[index] || {};
            productDataStore[index].files = productDataStore[index].files || [];
            
            for (var f = 0; f < files.length; f++) {
                var file = files[f];
                if (file.size > 10 * 1024 * 1024) {
                    alert('‚ùå "' + file.name + '" is too large. Max 10MB per file.');
                    continue;
                }
                
                (function(file) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        productDataStore[index].files.push({
                            name: file.name,
                            size: file.size,
                            mimeType: file.type,
                            data: e.target.result
                        });
                        renderFileList(index);
                    };
                    reader.readAsDataURL(file);
                })(file);
            }
        }
        
        function getFileIcon(name) {
            var ext = name.split('.').pop().toLowerCase();
            var icons = { pdf: 'üìï', doc: 'üìò', docx: 'üìò', xls: 'üìä', xlsx: 'üìä', csv: 'üìä', txt: 'üìÑ', zip: 'üóúÔ∏è', rar: 'üóúÔ∏è' };
            return icons[ext] || 'üìé';
        }
        
        function getMediaIcon(type) {
            if (type === 'image') return 'üñºÔ∏è';
            if (type === 'video') return 'üé¨';
            if (type === 'audio') return 'üéµ';
            return 'üìé';
        }
        
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function renderMediaList(index) {
            var listEl = document.getElementById('mediaList-' + index);
            if (!listEl) return;
            var media = (productDataStore[index] && productDataStore[index].media) || [];
            if (media.length === 0) { listEl.innerHTML = ''; return; }
            
            // Safely format index for JS calls
            var jsIdx = (typeof index === 'number') ? index : "'" + index + "'";
            
            var html = '';
            for (var m = 0; m < media.length; m++) {
                var item = media[m];
                var thumbHTML = '';
                if (item.type === 'image') {
                    thumbHTML = '<img src="' + item.data + '" style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px;">';
                } else if (item.type === 'video') {
                    thumbHTML = '<div style="width: 40px; height: 40px; background: #1a202c; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 20px;">üé¨</div>';
                } else if (item.type === 'audio') {
                    thumbHTML = '<div style="width: 40px; height: 40px; background: #553c9a; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer;" id="audioThumb-' + index + '-' + m + '">üéµ</div>';
                }
                
                html += '<div class="media-item">' +
                    thumbHTML +
                    '<div><div style="font-weight: 600;">' + item.name + '</div><div style="color: #9A8478; font-size: 11px;">' + getMediaIcon(item.type) + ' ' + item.type + ' ¬∑ ' + formatSize(item.size) + '</div></div>' +
                    '<button class="remove-btn" id="rmMedia-' + index + '-' + m + '" title="Remove">‚úï</button>' +
                '</div>';
            }
            listEl.innerHTML = html;
            
            // Wire buttons with addEventListener
            for (var m2 = 0; m2 < media.length; m2++) {
                (function(mi) {
                    var rmBtn = document.getElementById('rmMedia-' + index + '-' + mi);
                    if (rmBtn) rmBtn.addEventListener('click', function() { removeMedia(index, mi); });
                    
                    if (media[mi].type === 'audio') {
                        var audioThumb = document.getElementById('audioThumb-' + index + '-' + mi);
                        if (audioThumb) audioThumb.addEventListener('click', function() { playAudioPreview(index, mi); });
                    }
                })(m2);
            }
        }
        
        function renderFileList(index) {
            var listEl = document.getElementById('fileList-' + index);
            if (!listEl) return;
            var files = (productDataStore[index] && productDataStore[index].files) || [];
            if (files.length === 0) { listEl.innerHTML = ''; return; }
            
            var html = '';
            for (var f = 0; f < files.length; f++) {
                var item = files[f];
                html += '<div class="file-item">' +
                    '<div style="font-size: 24px;">' + getFileIcon(item.name) + '</div>' +
                    '<div><div style="font-weight: 600;">' + item.name + '</div><div style="color: #9A8478; font-size: 11px;">' + formatSize(item.size) + '</div></div>' +
                    '<button class="remove-btn" id="rmFile-' + index + '-' + f + '" title="Remove">‚úï</button>' +
                '</div>';
            }
            listEl.innerHTML = html;
            
            // Wire buttons with addEventListener
            for (var f2 = 0; f2 < files.length; f2++) {
                (function(fi) {
                    var rmBtn = document.getElementById('rmFile-' + index + '-' + fi);
                    if (rmBtn) rmBtn.addEventListener('click', function() { removeFile(index, fi); });
                })(f2);
            }
        }
        
        function removeMedia(index, mediaIndex) {
            if (productDataStore[index] && productDataStore[index].media) {
                var removed = productDataStore[index].media.splice(mediaIndex, 1)[0];
                // If removed item was the photo, clear it or set next image
                if (removed && removed.type === 'image' && productDataStore[index].photo === removed.data) {
                    productDataStore[index].photo = null;
                    var remaining = productDataStore[index].media.filter(function(m) { return m.type === 'image'; });
                    if (remaining.length > 0) {
                        productDataStore[index].photo = remaining[0].data;
                        productDataStore[index].filename = remaining[0].name;
                    }
                }
                renderMediaList(index);
                updateMediaPreview(index);
            }
        }
        
        function removeFile(index, fileIndex) {
            if (productDataStore[index] && productDataStore[index].files) {
                productDataStore[index].files.splice(fileIndex, 1);
                renderFileList(index);
            }
        }
        
        // Voice Recording
        var activeRecorders = {};
        
        function toggleRecording(index) {
            if (activeRecorders[index] && activeRecorders[index].state === 'recording') {
                stopRecording(index);
            } else {
                startRecording(index);
            }
        }
        
        function startRecording(index) {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('‚ö†Ô∏è Your browser does not support microphone access. Try uploading an audio file instead.');
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
                var mediaRecorder = new MediaRecorder(stream);
                var chunks = [];
                var startTime = Date.now();
                
                mediaRecorder.ondataavailable = function(e) {
                    if (e.data.size > 0) chunks.push(e.data);
                };
                
                mediaRecorder.onstop = function() {
                    stream.getTracks().forEach(function(t) { t.stop(); });
                    
                    var blob = new Blob(chunks, { type: 'audio/webm' });
                    var duration = Math.round((Date.now() - startTime) / 1000);
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var memoName = 'Voice Memo (' + formatDuration(duration) + ')';
                        
                        productDataStore[index] = productDataStore[index] || {};
                        productDataStore[index].media = productDataStore[index].media || [];
                        productDataStore[index].media.push({
                            name: memoName,
                            type: 'audio',
                            mimeType: 'audio/webm',
                            size: blob.size,
                            data: e.target.result,
                            duration: duration
                        });
                        
                        renderMediaList(index);
                        updateMediaPreview(index);
                    };
                    reader.readAsDataURL(blob);
                    
                    // Reset UI
                    var btn = document.getElementById('recBtn-' + index);
                    if (btn) { btn.classList.remove('recording'); }
                    var label = document.getElementById('recLabel-' + index);
                    if (label) label.textContent = 'Record Voice Memo';
                    var icon = document.getElementById('recIcon-' + index);
                    if (icon) icon.textContent = 'üé§';
                    var status = document.getElementById('recStatus-' + index);
                    if (status) status.style.display = 'none';
                    
                    if (activeRecorders[index] && activeRecorders[index].timer) {
                        clearInterval(activeRecorders[index].timer);
                    }
                    delete activeRecorders[index];
                };
                
                mediaRecorder.start();
                
                // Update UI
                var btn = document.getElementById('recBtn-' + index);
                if (btn) btn.classList.add('recording');
                var label = document.getElementById('recLabel-' + index);
                if (label) label.textContent = 'Recording...';
                var icon = document.getElementById('recIcon-' + index);
                if (icon) icon.textContent = '‚è∫';
                var status = document.getElementById('recStatus-' + index);
                if (status) status.style.display = 'flex';
                
                // Timer
                var timerEl = document.getElementById('recTimer-' + index);
                var timerInterval = setInterval(function() {
                    var elapsed = Math.round((Date.now() - startTime) / 1000);
                    if (timerEl) timerEl.textContent = formatDuration(elapsed);
                }, 1000);
                
                activeRecorders[index] = { recorder: mediaRecorder, stream: stream, timer: timerInterval, state: 'recording' };
                
            }).catch(function(err) {
                if (err.name === 'NotAllowedError') {
                    alert('üé§ Microphone access was denied. Please allow microphone access in your browser settings and try again.');
                } else {
                    alert('‚ö†Ô∏è Could not access microphone: ' + err.message);
                }
            });
        }
        
        function stopRecording(index) {
            if (activeRecorders[index] && activeRecorders[index].recorder) {
                activeRecorders[index].state = 'stopping';
                activeRecorders[index].recorder.stop();
            }
        }
        
        function formatDuration(seconds) {
            var mins = Math.floor(seconds / 60);
            var secs = seconds % 60;
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }
        
        var currentAudioPreview = null;
        function playAudioPreview(index, mediaIndex) {
            if (currentAudioPreview) {
                currentAudioPreview.pause();
                currentAudioPreview = null;
            }
            var store = productDataStore[index];
            if (store && store.media && store.media[mediaIndex]) {
                var audio = new Audio(store.media[mediaIndex].data);
                audio.play();
                currentAudioPreview = audio;
            }
        }
        
        function updateMediaPreview(index) {
            var preview = document.getElementById('preview-' + index);
            if (!preview) return;
            var media = (productDataStore[index] && productDataStore[index].media) || [];
            
            if (media.length === 0) {
                var isSingle = (index === 'single');
                preview.innerHTML = 
                    '<div style="font-size: ' + (isSingle ? '60' : '40') + 'px; margin-bottom: ' + (isSingle ? '15' : '8') + 'px;">üì∑ üé•</div>' +
                    '<div style="color: #C85A3E; font-weight: ' + (isSingle ? '700' : '600') + '; font-size: ' + (isSingle ? '16' : '14') + 'px;">Click to upload media</div>' +
                    '<div style="color: #9A8478; font-size: 12px; margin-top: ' + (isSingle ? '8' : '4') + 'px;">Photos, videos, or audio files ‚Äî up to 25MB</div>';
                return;
            }
            
            var images = media.filter(function(m) { return m.type === 'image'; });
            var videos = media.filter(function(m) { return m.type === 'video'; });
            var audios = media.filter(function(m) { return m.type === 'audio'; });
            
            var parts = [];
            if (images.length > 0) parts.push(images.length + ' photo' + (images.length > 1 ? 's' : ''));
            if (videos.length > 0) parts.push(videos.length + ' video' + (videos.length > 1 ? 's' : ''));
            if (audios.length > 0) parts.push(audios.length + ' voice memo' + (audios.length > 1 ? 's' : ''));
            
            var thumbHTML = '';
            if (images.length > 0) {
                thumbHTML = '<img src="' + images[0].data + '" style="max-height: 80px; border-radius: 8px; margin-bottom: 8px;">';
            }
            
            preview.innerHTML = 
                thumbHTML +
                '<div style="color: #81B29A; font-weight: 600; margin-top: 5px;">‚úì ' + parts.join(', ') + ' uploaded</div>' +
                '<div style="color: #9A8478; font-size: 13px;">Click to add more</div>';
        }
        
        function getProductData(index) {
            const details = document.getElementById(`details-${index}`)?.value || '';
            const store = productDataStore[index] || {};
            const photo = store.photo || null;
            const media = store.media || [];
            const files = store.files || [];
            
            return {
                details: details,
                photo: photo,
                media: media,
                files: files,
                hasData: details || photo || media.length > 0 || files.length > 0
            };
        }
        
        function getSingleProductData() {
            const details = document.getElementById('details-single')?.value || '';
            const store = productDataStore['single'] || {};
            const photo = store.photo || null;
            const media = store.media || [];
            const files = store.files || [];
            
            return {
                details: details,
                photo: photo,
                media: media,
                files: files,
                hasData: details || photo || media.length > 0 || files.length > 0
            };
        }
        
        function verify() {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            
            currentUser = { name, email };
            
            document.getElementById('authModal').classList.remove('active');
            document.getElementById('headerBtn').style.display = 'none';
            document.getElementById('userMenu').classList.add('active');
            document.getElementById('userEmail').textContent = email;
            
            showView('mode');
            
            alert('‚úÖ Email Verified!\n\nWelcome to Duy·ªÅn, ' + name + '!');
        }
        
        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('Please fill in all fields');
                return;
            }
            
            currentUser = { name: 'Demo User', email };
            
            document.getElementById('authModal').classList.remove('active');
            document.getElementById('headerBtn').style.display = 'none';
            document.getElementById('userMenu').classList.add('active');
            document.getElementById('userEmail').textContent = email;
            
            showView('mode');
        }
        
        function backToSignup() {
            document.getElementById('verifyForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
        }
        
        function logout() {
            currentUser = null;
            document.getElementById('headerBtn').style.display = 'block';
            document.getElementById('userMenu').classList.remove('active');
            showView('landing');
        }
        
        function selectMode(mode) {
            currentMode = mode;
            
            // --- Reset everything for a fresh start ---
            
            // Clear generated QR codes
            generatedQRCodes = [];
            document.getElementById('qrGrid').innerHTML = '';
            document.getElementById('qrResult').style.display = 'none';
            
            // Reset product data store
            productDataStore = {};
            productDataVisible = false;
            // Stop any active recordings
            Object.keys(activeRecorders).forEach(function(k) {
                if (activeRecorders[k] && activeRecorders[k].recorder) {
                    try { activeRecorders[k].recorder.stop(); } catch(e) {}
                }
                if (activeRecorders[k] && activeRecorders[k].timer) clearInterval(activeRecorders[k].timer);
            });
            activeRecorders = {};
            var toggleText = document.getElementById('toggleProductDataText');
            if (toggleText) toggleText.textContent = 'üìã Show Product Upload Forms';
            var productForms = document.getElementById('productDataForms');
            if (productForms) { productForms.innerHTML = ''; productForms.style.display = 'none'; }
            
            // Reset single form fields
            var singleLabel = document.getElementById('singleLabel');
            if (singleLabel) singleLabel.value = '';
            var detailsSingle = document.getElementById('details-single');
            if (detailsSingle) detailsSingle.value = '';
            var mediaSingle = document.getElementById('media-single');
            if (mediaSingle) mediaSingle.value = '';
            var filesSingle = document.getElementById('files-single');
            if (filesSingle) filesSingle.value = '';
            var previewSingle = document.getElementById('preview-single');
            if (previewSingle) previewSingle.innerHTML = '<div style="font-size: 60px; margin-bottom: 15px;">üì∑ üé•</div><div style="color: #C85A3E; font-weight: 700; font-size: 16px; margin-bottom: 8px;">Click to upload media</div><div style="color: #9A8478; font-size: 12px; margin-top: 8px;">Photos, videos, or audio files ‚Äî up to 25MB</div>';
            var mediaListSingle = document.getElementById('mediaList-single');
            if (mediaListSingle) mediaListSingle.innerHTML = '';
            var fileListSingle = document.getElementById('fileList-single');
            if (fileListSingle) fileListSingle.innerHTML = '';
            var filePreviewSingle = document.getElementById('filePreview-single');
            if (filePreviewSingle) filePreviewSingle.innerHTML = '<div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div><div style="color: #3D2E24; font-weight: 600;">Click to upload files</div><div style="color: #9A8478; font-size: 12px; margin-top: 5px;">PDF, DOC, XLS, TXT, ZIP ‚Äî up to 10MB each</div>';
            
            // Reset batch form fields
            var quantity = document.getElementById('quantity');
            if (quantity) quantity.value = '5';
            var prefix = document.getElementById('prefix');
            if (prefix) prefix.value = '';
            
            // Reset color to default
            selectedColor = '#C85A3E';
            document.getElementById('colorPicker').value = '#C85A3E';
            document.getElementById('hexInput').value = '#C85A3E';
            renderColorPresets();
            
            // Reset logo checkbox
            var includeLogo = document.getElementById('includeLogo');
            if (includeLogo) includeLogo.checked = true;
            
            // Reset base URL
            document.getElementById('baseUrl').value = 'https://duyen.io/q/';
            
            // Reset download preview
            var downloadPreview = document.getElementById('downloadPreview');
            if (downloadPreview) downloadPreview.style.display = 'none';
            
            // --- Show the correct form ---
            
            if (mode === 'single') {
                document.getElementById('generatorTitle').textContent = 'üì± Single QR Code Generator';
                document.getElementById('singleForm').style.display = 'block';
                document.getElementById('batchForm').style.display = 'none';
            } else {
                document.getElementById('generatorTitle').textContent = 'üì¶ Batch QR Code Generator';
                document.getElementById('singleForm').style.display = 'none';
                document.getElementById('batchForm').style.display = 'block';
            }
            
            showView('generator');
        }
        
        // Color functions
        function renderColorPresets() {
            const container = document.getElementById('colorPresets');
            container.innerHTML = colorPresets.map(color => `
                <div class="color-preset ${color === selectedColor ? 'selected' : ''}" 
                     style="background: ${color};" 
                     onclick="selectColor('${color}')"></div>
            `).join('');
        }
        
        function selectColor(color) {
            selectedColor = color;
            document.getElementById('colorPicker').value = color;
            document.getElementById('hexInput').value = color;
            renderColorPresets();
        }
        
        function updateCustomColor() {
            selectedColor = document.getElementById('colorPicker').value;
            document.getElementById('hexInput').value = selectedColor;
            renderColorPresets();
        }
        
        function updateFromHex() {
            const hex = document.getElementById('hexInput').value;
            if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
                selectedColor = hex;
                document.getElementById('colorPicker').value = hex;
                renderColorPresets();
            }
        }
        
        // Draw Duy√™n logo on QR code
        function drawLogoOnCanvas(canvas, color) {
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const logoSize = Math.min(canvas.width, canvas.height) * 0.22;
            
            // White circle background
            ctx.beginPath();
            ctx.arc(centerX, centerY, logoSize * 0.7, 0, Math.PI * 2);
            ctx.fillStyle = '#FFFFFF';
            ctx.fill();
            
            // Draw the Á∑£ character
            ctx.font = `bold ${logoSize}px serif`;
            ctx.fillStyle = color;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('Á∑£', centerX, centerY);
        }
        
        // Create high-res QR code canvas for downloads
        function createHighResQR(url, size, includeLogoPref) {
            const qr = qrcode(0, 'H'); // High error correction for logo
            qr.addData(url);
            qr.make();
            
            const moduleCount = qr.getModuleCount();
            const cellSize = Math.floor(size / moduleCount);
            const actualSize = cellSize * moduleCount;
            
            const canvas = document.createElement('canvas');
            canvas.width = actualSize;
            canvas.height = actualSize;
            const ctx = canvas.getContext('2d');
            
            // White background
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, actualSize, actualSize);
            
            // Draw QR modules
            ctx.fillStyle = selectedColor;
            for (let row = 0; row < moduleCount; row++) {
                for (let col = 0; col < moduleCount; col++) {
                    if (qr.isDark(row, col)) {
                        ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                    }
                }
            }
            
            // Add logo if enabled
            if (includeLogoPref) {
                drawLogoOnCanvas(canvas, selectedColor);
            }
            
            return canvas;
        }
        
        function generateQR() {
            const baseUrl = document.getElementById('baseUrl').value;
            const includeLogo = document.getElementById('includeLogo').checked;
            const grid = document.getElementById('qrGrid');
            grid.innerHTML = '';
            generatedQRCodes = []; // Reset stored QR codes
            
            let quantity, labels;
            
            if (currentMode === 'single') {
                quantity = 1;
                labels = [document.getElementById('singleLabel').value || 'QR Code'];
            } else {
                quantity = parseInt(document.getElementById('quantity').value);
                const prefix = document.getElementById('prefix').value || 'QR';
                labels = Array.from({length: quantity}, (_, i) => `${prefix}-${String(i+1).padStart(3, '0')}`);
            }
            
            for (let i = 0; i < quantity; i++) {
                const id = Math.random().toString(36).substring(2, 9);
                const url = baseUrl + id;
                
                // Get product data
                const productData = currentMode === 'single' ? getSingleProductData() : getProductData(i + 1);
                
                const item = document.createElement('div');
                item.className = 'qr-item';
                
                // Build full product data display
                let productDataDisplay = '';
                if (productData && productData.hasData) {
                    let photoHTML = '';
                    if (productData.photo) {
                        photoHTML = `
                            <div style="margin-bottom: 15px;">
                                <div style="font-weight: 600; color: #C85A3E; margin-bottom: 8px; font-size: 13px;">üì∏ Photo:</div>
                                <img src="${productData.photo}" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 2px solid #C85A3E;">
                            </div>
                        `;
                    }
                    
                    let mediaHTML = '';
                    if (productData.media && productData.media.length > 0) {
                        let videos = productData.media.filter(m => m.type === 'video');
                        let audios = productData.media.filter(m => m.type === 'audio');
                        let images = productData.media.filter(m => m.type === 'image');
                        let parts = [];
                        if (images.length > 0) parts.push(images.length + ' photo' + (images.length > 1 ? 's' : ''));
                        if (videos.length > 0) parts.push(videos.length + ' video' + (videos.length > 1 ? 's' : ''));
                        if (audios.length > 0) parts.push(audios.length + ' voice memo' + (audios.length > 1 ? 's' : ''));
                        mediaHTML = `
                            <div style="margin-bottom: 10px;">
                                <div style="font-weight: 600; color: #C85A3E; margin-bottom: 8px; font-size: 13px;">üé¨ Media: ${parts.join(', ')}</div>
                            </div>
                        `;
                    }
                    
                    let filesHTML = '';
                    if (productData.files && productData.files.length > 0) {
                        let fileNames = productData.files.map(f => f.name).join(', ');
                        filesHTML = `
                            <div style="margin-bottom: 10px;">
                                <div style="font-weight: 600; color: #C85A3E; margin-bottom: 8px; font-size: 13px;">üìé Files: ${productData.files.length} attached</div>
                                <div style="color: #7D6E64; font-size: 12px;">${fileNames}</div>
                            </div>
                        `;
                    }
                    
                    let detailsHTML = '';
                    if (productData.details) {
                        detailsHTML = `
                            <div>
                                <div style="font-weight: 600; color: #C85A3E; margin-bottom: 8px; font-size: 13px;">üìù Product Details:</div>
                                <div style="background: #f7fafc; padding: 12px; border-radius: 8px; border: 2px solid #E8DDD6; font-size: 12px; line-height: 1.6; white-space: pre-wrap;">${productData.details}</div>
                            </div>
                        `;
                    }
                    
                    productDataDisplay = `
                        <div style="background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%); padding: 15px; border-radius: 12px; margin-top: 15px; border: 2px solid #C85A3E;">
                            <div style="font-weight: 700; color: #C85A3E; margin-bottom: 12px; font-size: 14px;">‚úì Product Data Attached</div>
                            ${photoHTML}
                            ${mediaHTML}
                            ${filesHTML}
                            ${detailsHTML}
                        </div>
                    `;
                }
                
                item.innerHTML = `
                    <div class="qr-code" id="qr-${i}"></div>
                    <div class="qr-label">${labels[i]}</div>
                    <div style="font-size: 11px; color: #9A8478; margin-top: 5px;">${url}</div>
                    <button type="button" class="qr-download-btn" onclick="downloadSinglePNG(${i})">‚¨áÔ∏è Download PNG</button>
                    ${productDataDisplay}
                `;
                grid.appendChild(item);
                
                // Create QR code with custom color
                const qr = qrcode(0, 'H');
                qr.addData(url);
                qr.make();
                
                // Create colored QR code
                const qrContainer = document.getElementById(`qr-${i}`);
                const canvas = document.createElement('canvas');
                const moduleCount = qr.getModuleCount();
                const cellSize = 4;
                canvas.width = moduleCount * cellSize;
                canvas.height = moduleCount * cellSize;
                const ctx = canvas.getContext('2d');
                
                // White background
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw QR code in selected color
                ctx.fillStyle = selectedColor;
                for (let row = 0; row < moduleCount; row++) {
                    for (let col = 0; col < moduleCount; col++) {
                        if (qr.isDark(row, col)) {
                            ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                        }
                    }
                }
                
                // Add logo if enabled
                if (includeLogo) {
                    drawLogoOnCanvas(canvas, selectedColor);
                }
                
                qrContainer.appendChild(canvas);
                
                // Store for downloads
                generatedQRCodes.push({
                    url: url,
                    label: labels[i],
                    includeLogo: includeLogo
                });
                
                // Save to persistent library
                savedQRCodes.push({
                    id: id,
                    url: url,
                    label: labels[i],
                    color: selectedColor,
                    includeLogo: includeLogo,
                    details: productData ? productData.details : '',
                    photo: productData ? productData.photo : null,
                    media: productData ? (productData.media || []) : [],
                    files: productData ? (productData.files || []) : [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    status: (productData && productData.hasData) ? 'active' : 'draft'
                });
                updateQRCount();
            }
            
            document.getElementById('qrResult').style.display = 'block';
            document.getElementById('qrResult').scrollIntoView({behavior: 'smooth'});
        }
        
        // Download functions
        // Store generated image data for downloads
        let downloadDataStore = {};
        
        function downloadSinglePNG(index) {
            if (!generatedQRCodes || generatedQRCodes.length === 0) {
                alert('‚ö†Ô∏è Please generate QR codes first!');
                return;
            }
            
            const qrData = generatedQRCodes[index];
            if (!qrData) {
                alert('‚ö†Ô∏è QR code not found');
                return;
            }
            
            const canvas = createHighResQR(qrData.url, 400, qrData.includeLogo);
            const dataUrl = canvas.toDataURL('image/png');
            
            // Store for download
            downloadDataStore['single_' + index] = {
                dataUrl: dataUrl,
                filename: 'duyen-' + qrData.label + '.png'
            };
            
            showDownloadPreview(`
                <div style="text-align: center;">
                    <h4 style="color: #166534; margin-bottom: 15px;">üñºÔ∏è PNG Preview: ${qrData.label}</h4>
                    <div style="background: #f0f0f0; padding: 30px; border-radius: 12px; display: inline-block;">
                        <img id="downloadImg-single-${index}" src="${dataUrl}" style="width: 200px; height: 200px; border: 3px solid #22c55e; border-radius: 8px;">
                    </div>
                    <p style="margin-top: 15px; color: #7D6E64; font-size: 14px;"><strong>400 √ó 400 pixels</strong> ‚Ä¢ PNG format</p>
                    <button onclick="triggerPNGDownload('single_${index}')" type="button"
                       style="display: inline-block; margin-top: 20px; padding: 16px 32px; background: #22c55e; color: white; border-radius: 8px; border: none; font-weight: 600; font-size: 16px; cursor: pointer;">
                        ‚¨áÔ∏è Download ${qrData.label}.png
                    </button>
                    <p style="margin-top: 12px; color: #9A8478; font-size: 12px;">Or right-click image above ‚Üí "Save Image As"</p>
                </div>
            `);
        }
        
        function smartDownload(dataUrl, filename) {
            // Always show the save overlay ‚Äî works everywhere including webviews
            showSaveOverlay(dataUrl, filename);
        }

        function showSaveOverlay(dataUrl, filename) {
            // Remove any existing overlay
            var existing = document.getElementById('mobileSaveOverlay');
            if (existing) existing.remove();

            var isPDF = filename.endsWith('.pdf');
            
            var overlay = document.createElement('div');
            overlay.id = 'mobileSaveOverlay';
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(61,46,36,0.95);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;overflow-y:auto;';
            
            overlay.innerHTML = 
                '<div style="background:white;border-radius:20px;padding:2rem;max-width:380px;width:100%;text-align:center;margin:auto;">' +
                    '<p style="font-weight:700;font-size:1.15rem;color:#3D2E24;margin-bottom:0.5rem;">Save Your QR Code</p>' +
                    '<p style="font-size:0.85rem;color:#9A8478;margin-bottom:1.25rem;">' + filename + '</p>' +
                    (isPDF ? '' : '<img id="saveOverlayImg" src="' + dataUrl + '" style="width:260px;height:260px;border:3px solid #E8DDD6;border-radius:12px;margin-bottom:1.25rem;display:block;margin-left:auto;margin-right:auto;">') +
                    '<div style="background:#FAF0EA;border-radius:12px;padding:1rem;margin-bottom:1.25rem;text-align:left;">' +
                        '<p style="font-weight:600;color:#3D2E24;font-size:0.9rem;margin-bottom:0.5rem;">üì± On phone:</p>' +
                        (isPDF ? 
                            '<p style="color:#5D4E44;font-size:0.85rem;line-height:1.6;">Use the <strong>"Open Printable Page"</strong> button instead, then use your browser\'s Print ‚Üí Save as PDF</p>'
                            :
                            '<p style="color:#5D4E44;font-size:0.85rem;line-height:1.6;"><strong>Long press</strong> the image above ‚Üí tap <strong>"Save to Photos"</strong> or <strong>"Add to Photos"</strong></p>'
                        ) +
                        '<p style="font-weight:600;color:#3D2E24;font-size:0.9rem;margin-bottom:0.5rem;margin-top:0.75rem;">üíª On computer:</p>' +
                        (isPDF ?
                            '<p style="color:#5D4E44;font-size:0.85rem;line-height:1.6;">Click <strong>"Download PDF"</strong> from the preview, or use Print ‚Üí Save as PDF</p>'
                            :
                            '<p style="color:#5D4E44;font-size:0.85rem;line-height:1.6;"><strong>Right-click</strong> the image ‚Üí <strong>"Save Image As"</strong></p>'
                        ) +
                    '</div>' +
                    '<button onclick="document.getElementById(\'mobileSaveOverlay\').remove()" style="background:#C85A3E;color:white;border:none;padding:0.875rem 2rem;border-radius:12px;font-size:1rem;font-weight:600;cursor:pointer;font-family:inherit;width:100%;">Done</button>' +
                '</div>';

            document.body.appendChild(overlay);
            
            // Also attempt real download in background (works outside webview)
            if (!isPDF) {
                try {
                    var byteString = atob(dataUrl.split(',')[1]);
                    var mimeType = dataUrl.split(',')[0].split(':')[1].split(';')[0];
                    var uint8Array = new Uint8Array(byteString.length);
                    for (var i = 0; i < byteString.length; i++) {
                        uint8Array[i] = byteString.charCodeAt(i);
                    }
                    var blob = new Blob([uint8Array], { type: mimeType });
                    var blobUrl = URL.createObjectURL(blob);
                    var link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = filename;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    setTimeout(function() {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(blobUrl);
                    }, 300);
                } catch(e) {
                    // Silent fail ‚Äî overlay is the fallback
                }
            }
        }

        function fallbackDownload(dataUrl, filename) {
            showSaveOverlay(dataUrl, filename);
        }

        function triggerPNGDownload(storeKey) {
            var data = downloadDataStore[storeKey];
            if (!data) {
                alert('Download data not found. Please try again.');
                return;
            }
            smartDownload(data.dataUrl, data.filename);
        }
        
        
        function downloadAllPNG() {
            if (!generatedQRCodes || generatedQRCodes.length === 0) {
                alert('‚ö†Ô∏è Please generate QR codes first!');
                return;
            }
            
            let previewHTML = `
                <div style="text-align: center;">
                    <h4 style="color: #166534; margin-bottom: 8px;">üñºÔ∏è Your QR Code${generatedQRCodes.length > 1 ? 's' : ''}</h4>
                    <p style="color: #7D6E64; font-size: 13px; margin-bottom: 20px;">üì± <strong>Long press</strong> any image to save ¬∑ üíª <strong>Right-click</strong> ‚Üí Save Image As</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;">
            `;
            
            generatedQRCodes.forEach((qrData, index) => {
                const canvas = createHighResQR(qrData.url, 400, qrData.includeLogo);
                const dataUrl = canvas.toDataURL('image/png');
                
                // Store for download
                downloadDataStore['all_' + index] = {
                    dataUrl: dataUrl,
                    filename: 'duyen-' + qrData.label + '.png'
                };
                
                previewHTML += `
                    <div style="background: white; padding: 20px; border-radius: 16px; text-align: center; border: 2px solid #E8DDD6;">
                        <img src="${dataUrl}" style="width: 180px; height: 180px; border: 2px solid #E8DDD6; border-radius: 8px; display: block; margin: 0 auto 12px;">
                        <p style="margin: 0 0 10px; color: #3D2E24; font-weight: 600; font-size: 14px;">${qrData.label}</p>
                        <button onclick="triggerPNGDownload('all_${index}')" type="button"
                           style="padding: 10px 20px; background: #C85A3E; color: white; border-radius: 10px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; width: 100%;">
                            Save Image
                        </button>
                    </div>
                `;
            });
            
            previewHTML += `
                    </div>
                </div>
            `;
            
            showDownloadPreview(previewHTML);
        }
        
        function showDownloadPreview(html) {
            const preview = document.getElementById('downloadPreview');
            const content = document.getElementById('previewContent');
            content.innerHTML = html;
            preview.style.display = 'block';
            preview.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function downloadPDF() {
            if (!generatedQRCodes || generatedQRCodes.length === 0) {
                alert('‚ö†Ô∏è Please generate QR codes first!');
                return;
            }
            
            // Show PDF preview with embedded printable version
            showPDFPreview();
        }
        
        function showPDFPreview() {
            const scale = 0.6; // Scale for preview
            const pageW = 8.5 * 96 * scale;
            const pageH = 11 * 96 * scale;
            const qrSizePx = 2 * 96 * scale;
            const margin = 0.75 * 96 * scale;
            const gapX = 0.25 * 96 * scale;
            const gapY = 0.5 * 96 * scale;
            const cols = 3;
            const rows = 4;
            
            const totalPages = Math.ceil(generatedQRCodes.length / (cols * rows));
            let pagesHTML = '';
            
            // Store image data for print
            let printImageData = [];
            
            for (let page = 0; page < totalPages; page++) {
                let pageContent = '';
                const startIdx = page * cols * rows;
                const endIdx = Math.min(startIdx + cols * rows, generatedQRCodes.length);
                
                for (let i = startIdx; i < endIdx; i++) {
                    const qrData = generatedQRCodes[i];
                    const canvas = createHighResQR(qrData.url, 200, qrData.includeLogo);
                    const dataUrl = canvas.toDataURL('image/png');
                    
                    printImageData.push({ dataUrl, label: qrData.label });
                    
                    const pageIndex = i - startIdx;
                    const col = pageIndex % cols;
                    const row = Math.floor(pageIndex / cols);
                    
                    const x = margin + col * (qrSizePx + gapX);
                    const y = margin + row * (qrSizePx + gapY);
                    
                    pageContent += `
                        <div style="position: absolute; left: ${x}px; top: ${y}px; text-align: center;">
                            <img src="${dataUrl}" style="width: ${qrSizePx}px; height: ${qrSizePx}px;">
                            <div style="font-size: 9px; color: #7D6E64; margin-top: 3px;">${qrData.label}</div>
                        </div>
                    `;
                }
                
                pagesHTML += `
                    <div style="position: relative; width: ${pageW}px; height: ${pageH}px; background: white; border: 2px solid #ccc; margin: 10px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="position: absolute; top: 5px; right: 10px; font-size: 9px; color: #9A8478;">Page ${page + 1}/${totalPages}</div>
                        ${pageContent}
                    </div>
                `;
            }
            
            // Store for printing
            window.currentPrintData = { type: 'standard', images: printImageData };
            
            const previewHTML = `
                <div style="text-align: center;">
                    <h4 style="color: #166534; margin-bottom: 10px;">üìÑ PDF Preview: Standard Layout</h4>
                    <p style="color: #7D6E64; font-size: 13px; margin-bottom: 15px;">
                        <strong>${generatedQRCodes.length}</strong> QR codes ‚Ä¢ <strong>${totalPages}</strong> page(s) ‚Ä¢ 2" √ó 2" each
                    </p>
                    
                    <div style="max-height: 400px; overflow-y: auto; background: #e8e8e8; padding: 15px; border-radius: 12px;">
                        ${pagesHTML}
                    </div>
                    
                    <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 12px; border: 2px solid #ffc107;">
                        <p style="color: #856404; font-weight: 600; margin-bottom: 15px;">üì• Download Options:</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                            <button onclick="tryJsPDFDownload('standard')" type="button"
                               style="padding: 14px 24px; background: #C85A3E; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                ‚¨áÔ∏è Download PDF
                            </button>
                            <button onclick="showPrintableInPage('standard')" type="button"
                               style="padding: 14px 24px; background: #3182ce; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                üñ®Ô∏è Open Printable Page
                            </button>
                        </div>
                        <p style="color: #856404; font-size: 12px; margin-top: 12px;">
                            If "Download PDF" doesn't work, use "Open Printable Page" then press Ctrl+P ‚Üí Save as PDF
                        </p>
                    </div>
                </div>
            `;
            
            showDownloadPreview(previewHTML);
        }
        
        function downloadAveryPDF(templateId) {
            if (!generatedQRCodes || generatedQRCodes.length === 0) {
                alert('‚ö†Ô∏è Please generate QR codes first!');
                return;
            }
            
            const template = averyTemplates[templateId];
            if (!template) {
                alert('‚ö†Ô∏è Template not found');
                return;
            }
            
            showAveryPreview(templateId);
        }
        
        function showAveryPreview(templateId) {
            const template = averyTemplates[templateId];
            const scale = 0.6;
            
            const pageW = 8.5 * 96 * scale;
            const pageH = 11 * 96 * scale;
            const labelW = template.labelW * 96 * scale;
            const labelH = template.labelH * 96 * scale;
            const marginLeft = template.marginLeft * 96 * scale;
            const marginTop = template.marginTop * 96 * scale;
            const gapX = template.gapX * 96 * scale;
            const gapY = template.gapY * 96 * scale;
            
            const totalPages = Math.ceil(generatedQRCodes.length / template.perSheet);
            let pagesHTML = '';
            let printImageData = [];
            
            for (let page = 0; page < totalPages; page++) {
                let pageContent = '';
                let qrIndex = page * template.perSheet;
                
                for (let row = 0; row < template.rows; row++) {
                    for (let col = 0; col < template.cols; col++) {
                        const x = marginLeft + col * (labelW + gapX);
                        const y = marginTop + row * (labelH + gapY);
                        
                        const borderRadius = template.round ? '50%' : '3px';
                        pageContent += `<div style="position: absolute; left: ${x}px; top: ${y}px; width: ${labelW}px; height: ${labelH}px; border: 1px dashed #ccc; border-radius: ${borderRadius};"></div>`;
                        
                        if (qrIndex < generatedQRCodes.length) {
                            const qrData = generatedQRCodes[qrIndex];
                            const qrSizePx = Math.min(labelW, labelH) * 0.7;
                            const canvas = createHighResQR(qrData.url, 150, qrData.includeLogo);
                            const dataUrl = canvas.toDataURL('image/png');
                            
                            printImageData.push({ dataUrl, label: qrData.label });
                            
                            const qrX = x + (labelW - qrSizePx) / 2;
                            const qrY = y + (labelH - qrSizePx) / 2 - (labelH >= 50 ? 6 : 0);
                            
                            pageContent += `
                                <div style="position: absolute; left: ${qrX}px; top: ${qrY}px; text-align: center;">
                                    <img src="${dataUrl}" style="width: ${qrSizePx}px; height: ${qrSizePx}px; ${template.round ? 'border-radius: 50%;' : ''}">
                                    ${labelH >= 50 ? `<div style="font-size: 7px; color: #7D6E64; margin-top: 1px;">${qrData.label}</div>` : ''}
                                </div>
                            `;
                            qrIndex++;
                        }
                    }
                }
                
                pagesHTML += `
                    <div style="position: relative; width: ${pageW}px; height: ${pageH}px; background: white; border: 2px solid #ccc; margin: 10px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="position: absolute; top: 5px; right: 10px; font-size: 9px; color: #9A8478;">Page ${page + 1}/${totalPages}</div>
                        <div style="position: absolute; top: 5px; left: 10px; font-size: 8px; color: #C85A3E; font-weight: 600;">${template.name}</div>
                        ${pageContent}
                    </div>
                `;
            }
            
            window.currentPrintData = { type: templateId, template: template, images: printImageData };
            
            const previewHTML = `
                <div style="text-align: center;">
                    <h4 style="color: #166534; margin-bottom: 10px;">üè∑Ô∏è Avery Preview: ${template.name}</h4>
                    <p style="color: #7D6E64; font-size: 13px; margin-bottom: 5px;">
                        <strong>${generatedQRCodes.length}</strong> QR codes ‚Ä¢ <strong>${totalPages}</strong> page(s) ‚Ä¢ ${template.perSheet} per sheet
                    </p>
                    <p style="color: #9A8478; font-size: 11px; margin-bottom: 15px;">
                        Label: ${template.labelW}" √ó ${template.labelH}" ${template.round ? '(Round)' : ''}
                    </p>
                    
                    <div style="max-height: 400px; overflow-y: auto; background: #e8e8e8; padding: 15px; border-radius: 12px;">
                        ${pagesHTML}
                    </div>
                    
                    <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 12px; border: 2px solid #ffc107;">
                        <p style="color: #856404; font-weight: 600; margin-bottom: 15px;">üì• Download Options:</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                            <button onclick="tryJsPDFDownload('${templateId}')" type="button"
                               style="padding: 14px 24px; background: #C85A3E; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                ‚¨áÔ∏è Download PDF
                            </button>
                            <button onclick="showPrintableInPage('${templateId}')" type="button"
                               style="padding: 14px 24px; background: #3182ce; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                üñ®Ô∏è Open Printable Page
                            </button>
                        </div>
                        <p style="color: #856404; font-size: 12px; margin-top: 12px;">
                            Print Tip: Select <strong>"Actual Size"</strong> in print settings for correct label alignment
                        </p>
                    </div>
                </div>
            `;
            
            showDownloadPreview(previewHTML);
        }
        
        function tryJsPDFDownload(templateId) {
            // Try to initialize jsPDF
            if (!jsPDF) {
                try {
                    jsPDF = window.jspdf ? window.jspdf.jsPDF : null;
                } catch(e) {}
            }
            
            if (!jsPDF) {
                alert('üìÑ PDF library not available in preview mode.\n\nClick "Open Printable Page" instead, then:\n1. Press Ctrl+P (or Cmd+P on Mac)\n2. Select "Save as PDF" as the printer\n3. Click Save');
                return;
            }
            
            try {
                const pdf = new jsPDF('p', 'in', 'letter');
                
                if (templateId === 'standard') {
                    const qrSize = 2;
                    const margin = 0.75;
                    const cols = 3;
                    const rows = 4;
                    
                    generatedQRCodes.forEach((qrData, index) => {
                        if (index > 0 && index % (cols * rows) === 0) {
                            pdf.addPage();
                        }
                        
                        const pageIndex = index % (cols * rows);
                        const col = pageIndex % cols;
                        const row = Math.floor(pageIndex / cols);
                        
                        const x = margin + col * (qrSize + 0.25);
                        const y = margin + row * (qrSize + 0.5);
                        
                        const canvas = createHighResQR(qrData.url, 400, qrData.includeLogo);
                        const imgData = canvas.toDataURL('image/png');
                        
                        pdf.addImage(imgData, 'PNG', x, y, qrSize, qrSize);
                        pdf.setFontSize(8);
                        pdf.setTextColor(100);
                        pdf.text(qrData.label, x + qrSize/2, y + qrSize + 0.15, { align: 'center' });
                    });
                    
                    pdf.save('duyen-qr-codes.pdf');
                } else {
                    const template = averyTemplates[templateId];
                    let qrIndex = 0;
                    let pageNum = 0;
                    
                    while (qrIndex < generatedQRCodes.length) {
                        if (pageNum > 0) pdf.addPage();
                        
                        for (let row = 0; row < template.rows && qrIndex < generatedQRCodes.length; row++) {
                            for (let col = 0; col < template.cols && qrIndex < generatedQRCodes.length; col++) {
                                const qrData = generatedQRCodes[qrIndex];
                                
                                const x = template.marginLeft + col * (template.labelW + template.gapX);
                                const y = template.marginTop + row * (template.labelH + template.gapY);
                                
                                const qrSize = Math.min(template.labelW, template.labelH) * 0.75;
                                const qrX = x + (template.labelW - qrSize) / 2;
                                const qrY = y + (template.labelH - qrSize) / 2 - 0.1;
                                
                                const canvas = createHighResQR(qrData.url, 400, qrData.includeLogo);
                                const imgData = canvas.toDataURL('image/png');
                                
                                pdf.addImage(imgData, 'PNG', qrX, qrY, qrSize, qrSize);
                                
                                if (template.labelH >= 1) {
                                    pdf.setFontSize(7);
                                    pdf.setTextColor(100);
                                    pdf.text(qrData.label, x + template.labelW/2, qrY + qrSize + 0.12, { align: 'center' });
                                }
                                
                                qrIndex++;
                            }
                        }
                        pageNum++;
                    }
                    
                    pdf.save('duyen-' + templateId + '-labels.pdf');
                }
                
                alert('‚úÖ PDF Downloaded!');
            } catch (err) {
                console.error('PDF error:', err);
                alert('üìÑ PDF download failed.\n\nClick "Open Printable Page" instead to save as PDF.');
            }
        }
        
        function showPrintableInPage(templateId) {
            const isAvery = templateId !== 'standard';
            const template = isAvery ? averyTemplates[templateId] : null;
            const templateName = isAvery ? template.name : 'Standard Layout';
            
            // Build printable content
            let pagesHTML = '';
            
            if (isAvery) {
                const totalPages = Math.ceil(generatedQRCodes.length / template.perSheet);
                
                for (let page = 0; page < totalPages; page++) {
                    let pageContent = '';
                    let qrIndex = page * template.perSheet;
                    
                    for (let row = 0; row < template.rows && qrIndex < generatedQRCodes.length; row++) {
                        for (let col = 0; col < template.cols && qrIndex < generatedQRCodes.length; col++) {
                            const qrData = generatedQRCodes[qrIndex];
                            const canvas = createHighResQR(qrData.url, 400, qrData.includeLogo);
                            const dataUrl = canvas.toDataURL('image/png');
                            
                            const x = template.marginLeft + col * (template.labelW + template.gapX);
                            const y = template.marginTop + row * (template.labelH + template.gapY);
                            const qrSize = Math.min(template.labelW, template.labelH) * 0.75;
                            const qrX = x + (template.labelW - qrSize) / 2;
                            const qrY = y + (template.labelH - qrSize) / 2 - 0.08;
                            
                            pageContent += '<div style="position:absolute;left:' + qrX + 'in;top:' + qrY + 'in;text-align:center;">';
                            pageContent += '<img src="' + dataUrl + '" style="width:' + qrSize + 'in;height:' + qrSize + 'in;">';
                            if (template.labelH >= 1) {
                                pageContent += '<div style="font-size:9px;color:#666;margin-top:3px;">' + qrData.label + '</div>';
                            }
                            pageContent += '</div>';
                            qrIndex++;
                        }
                    }
                    
                    pagesHTML += '<div class="page">' + pageContent + '</div>';
                }
            } else {
                const cols = 3, rows = 4;
                const qrSize = 2;
                const margin = 0.75;
                const totalPages = Math.ceil(generatedQRCodes.length / (cols * rows));
                
                for (let page = 0; page < totalPages; page++) {
                    let pageContent = '';
                    const startIdx = page * cols * rows;
                    const endIdx = Math.min(startIdx + cols * rows, generatedQRCodes.length);
                    
                    for (let i = startIdx; i < endIdx; i++) {
                        const qrData = generatedQRCodes[i];
                        const canvas = createHighResQR(qrData.url, 400, qrData.includeLogo);
                        const dataUrl = canvas.toDataURL('image/png');
                        
                        const pageIndex = i - startIdx;
                        const col = pageIndex % cols;
                        const row = Math.floor(pageIndex / cols);
                        
                        const x = margin + col * (qrSize + 0.25);
                        const y = margin + row * (qrSize + 0.5);
                        
                        pageContent += '<div style="position:absolute;left:' + x + 'in;top:' + y + 'in;text-align:center;">';
                        pageContent += '<img src="' + dataUrl + '" style="width:' + qrSize + 'in;height:' + qrSize + 'in;">';
                        pageContent += '<div style="font-size:9px;color:#666;margin-top:3px;">' + qrData.label + '</div>';
                        pageContent += '</div>';
                    }
                    
                    pagesHTML += '<div class="page">' + pageContent + '</div>';
                }
            }
            
            // Create full HTML document
            const printHTML = '<!DOCTYPE html><html><head><title>Duyen QR - ' + templateName + '</title>' +
                '<style>' +
                '@page{size:letter;margin:0}' +
                '@media print{.no-print{display:none!important}.page{page-break-after:always}.page:last-child{page-break-after:avoid}}' +
                'body{margin:0;padding:0;font-family:Arial,sans-serif}' +
                '.page{width:8.5in;height:11in;position:relative;box-sizing:border-box}' +
                '.header{padding:20px;background:#f8f8f8;text-align:center;border-bottom:2px solid #C85A3E}' +
                '</style></head><body>' +
                '<div class="header no-print">' +
                '<h2 style="color:#C85A3E;margin:0 0 10px">üñ®Ô∏è ' + templateName + ' - Ready to Print</h2>' +
                '<p style="margin:0 0 15px;color:#666">Press <strong>Ctrl+P</strong> (Windows) or <strong>Cmd+P</strong> (Mac) to print or save as PDF</p>' +
                '<p style="margin:0 0 15px;color:#C85A3E;font-weight:bold">‚ö†Ô∏è Important: Select "Actual Size" in print settings!</p>' +
                '<button onclick="window.print()" style="padding:15px 40px;font-size:18px;background:#C85A3E;color:white;border:none;border-radius:8px;cursor:pointer">üñ®Ô∏è Print Now</button>' +
                '</div>' +
                pagesHTML +
                '</body></html>';
            
            // Try to open in new window/tab
            try {
                const blob = new Blob([printHTML], { type: 'text/html' });
                const blobUrl = URL.createObjectURL(blob);
                const newWindow = window.open(blobUrl, '_blank');
                
                if (!newWindow || newWindow.closed) {
                    // Popup blocked - show inline instead
                    showInlinePreview(printHTML, templateName);
                } else {
                    // Clean up blob URL after a delay
                    setTimeout(function() {
                        URL.revokeObjectURL(blobUrl);
                    }, 60000);
                }
            } catch (err) {
                console.error('Window open failed:', err);
                showInlinePreview(printHTML, templateName);
            }
        }
        
        function showInlinePreview(printHTML, templateName) {
            // Show in iframe within the page
            const previewHTML = `
                <div style="text-align: center;">
                    <h4 style="color: #C85A3E; margin-bottom: 10px;">üñ®Ô∏è Printable Version: ${templateName}</h4>
                    <p style="color: #7D6E64; margin-bottom: 15px;">
                        Click inside the preview below, then press <strong>Ctrl+P</strong> (or Cmd+P) to print/save as PDF
                    </p>
                    
                    <div style="border: 3px solid #C85A3E; border-radius: 8px; overflow: hidden; background: white;">
                        <iframe id="printFrame" style="width: 100%; height: 600px; border: none;"></iframe>
                    </div>
                    
                    <button onclick="printIframe()" type="button" style="margin-top: 20px; padding: 16px 40px; background: #C85A3E; color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 16px; cursor: pointer;">
                        üñ®Ô∏è Print This Page
                    </button>
                </div>
            `;
            
            showDownloadPreview(previewHTML);
            
            // Write content to iframe after a short delay
            setTimeout(function() {
                const iframe = document.getElementById('printFrame');
                if (iframe) {
                    const doc = iframe.contentDocument || iframe.contentWindow.document;
                    doc.open();
                    doc.write(printHTML);
                    doc.close();
                }
            }, 100);
        }
        
        function printIframe() {
            const iframe = document.getElementById('printFrame');
            if (iframe) {
                iframe.contentWindow.focus();
                iframe.contentWindow.print();
            }
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            renderColorPresets();
            
            // Check if required libraries loaded
            setTimeout(function() {
                if (typeof qrcode === 'undefined') {
                    console.warn('QR code library not loaded');
                }
                if (!jsPDF) {
                    // Try to get it again after DOM load
                    try {
                        jsPDF = window.jspdf ? window.jspdf.jsPDF : null;
                    } catch(e) {
                        console.warn('jsPDF still not available');
                    }
                }
                console.log('Libraries loaded - qrcode:', typeof qrcode !== 'undefined', 'jsPDF:', !!jsPDF);
            }, 500);
        });
        
        // ==============================
        // MY QR CODES - Management
        // ==============================
        
        function updateQRCount() {
            var countEl = document.getElementById('qrCount');
            if (countEl) countEl.textContent = savedQRCodes.length;
        }
        
        function renderMyCodes() {
            var grid = document.getElementById('myCodesGrid');
            var emptyState = document.getElementById('myCodesEmpty');
            var subtitle = document.getElementById('myCodesSubtitle');
            var search = (document.getElementById('searchCodes').value || '').toLowerCase();
            var filterStatus = document.getElementById('filterStatus').value;
            
            var filtered = savedQRCodes.filter(function(qr) {
                var matchSearch = !search || qr.label.toLowerCase().indexOf(search) !== -1 || (qr.details && qr.details.toLowerCase().indexOf(search) !== -1);
                var matchStatus = filterStatus === 'all' || qr.status === filterStatus;
                return matchSearch && matchStatus;
            });
            
            subtitle.textContent = savedQRCodes.length + ' code' + (savedQRCodes.length !== 1 ? 's' : '') + ' created';
            
            if (savedQRCodes.length === 0) {
                emptyState.style.display = 'block';
                grid.style.display = 'none';
                return;
            }
            
            emptyState.style.display = 'none';
            grid.style.display = 'grid';
            grid.innerHTML = '';
            
            if (filtered.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #9A8478;">No QR codes match your search.</div>';
                return;
            }
            
            var sorted = filtered.slice().reverse();
            
            for (var s = 0; s < sorted.length; s++) {
                (function(qrItem, realIndex) {
                    var card = document.createElement('div');
                    card.className = 'qr-card' + (batchEditMode ? ' batch-mode' : '') + (batchSelectedIndices.has(realIndex) ? ' batch-selected' : '');
                    
                    var badges = '';
                    var statusClass = qrItem.status === 'active' ? 'active' : 'draft';
                    var statusLabel = qrItem.status === 'active' ? '‚óè Active' : '‚óã Draft';
                    badges += '<span class="qr-badge ' + statusClass + '">' + statusLabel + '</span>';
                    
                    var mediaCount = (qrItem.media || []).length;
                    if (qrItem.photo && mediaCount === 0) mediaCount = 1;
                    if (mediaCount > 0) badges += '<span class="qr-badge media">' + mediaCount + ' media</span>';
                    if (qrItem.files && qrItem.files.length > 0) badges += '<span class="qr-badge files">' + qrItem.files.length + ' file' + (qrItem.files.length > 1 ? 's' : '') + '</span>';
                    if (qrItem.details) badges += '<span class="qr-badge details">üìù Details</span>';
                    
                    var dateStr = new Date(qrItem.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    
                    // Build data boxes
                    var dataBoxesHTML = '';
                    var hasAnyData = qrItem.details || qrItem.photo || (qrItem.media && qrItem.media.length > 0) || (qrItem.files && qrItem.files.length > 0);
                    
                    if (hasAnyData) {
                        dataBoxesHTML += '<div class="qr-card-data" id="cardData-' + realIndex + '" title="Click to view all data">';
                        
                        if (qrItem.photo) {
                            dataBoxesHTML += '<div class="card-data-box card-data-photo"><img src="' + qrItem.photo + '" style="width: 100%; height: 80px; object-fit: cover; border-radius: 6px;"></div>';
                        }
                        
                        var mediaItems = qrItem.media || [];
                        if (mediaItems.length > 0) {
                            dataBoxesHTML += '<div class="card-data-box card-data-media"><div class="card-data-box-label">üì∏ Media</div>';
                            for (var mi = 0; mi < Math.min(mediaItems.length, 3); mi++) {
                                var mItem = mediaItems[mi];
                                var mIcon = mItem.type === 'image' ? 'üñºÔ∏è' : mItem.type === 'video' ? 'üé¨' : 'üéµ';
                                dataBoxesHTML += '<div class="card-data-row">' + mIcon + ' ' + mItem.name + '</div>';
                            }
                            if (mediaItems.length > 3) dataBoxesHTML += '<div class="card-data-row" style="color: #C85A3E;">+' + (mediaItems.length - 3) + ' more</div>';
                            dataBoxesHTML += '</div>';
                        }
                        
                        var fileItems = qrItem.files || [];
                        if (fileItems.length > 0) {
                            dataBoxesHTML += '<div class="card-data-box card-data-files"><div class="card-data-box-label">üìé Files</div>';
                            for (var fi = 0; fi < Math.min(fileItems.length, 3); fi++) {
                                dataBoxesHTML += '<div class="card-data-row">üìÑ ' + fileItems[fi].name + '</div>';
                            }
                            if (fileItems.length > 3) dataBoxesHTML += '<div class="card-data-row" style="color: #C85A3E;">+' + (fileItems.length - 3) + ' more</div>';
                            dataBoxesHTML += '</div>';
                        }
                        
                        if (qrItem.details) {
                            var truncated = qrItem.details.length > 100 ? qrItem.details.substring(0, 100) + '‚Ä¶' : qrItem.details;
                            dataBoxesHTML += '<div class="card-data-box card-data-details"><div class="card-data-box-label">üìù Details</div><div class="card-data-text">' + truncated + '</div></div>';
                        }
                        
                        dataBoxesHTML += '<div style="text-align: center; font-size: 11px; color: #C85A3E; font-weight: 600; margin-top: 4px; opacity: 0.7;">tap to view all ‚Üí</div>';
                        dataBoxesHTML += '</div>';
                    } else {
                        dataBoxesHTML = '<div style="margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 8px; text-align: center; font-size: 12px; color: #9A8478;">No data attached</div>';
                    }
                    
                    // Batch checkbox
                    var checkboxHTML = batchEditMode 
                        ? '<div class="batch-checkbox-overlay"><input type="checkbox" id="batchCb-' + realIndex + '" ' + (batchSelectedIndices.has(realIndex) ? 'checked' : '') + ' style="width: 22px; height: 22px; accent-color: #C85A3E; cursor: pointer;"></div>'
                        : '';
                    
                    card.innerHTML =
                        checkboxHTML +
                        '<div class="qr-card-preview"><canvas id="cardQR-' + realIndex + '" width="120" height="120"></canvas></div>' +
                        '<div class="qr-card-body">' +
                            '<div class="qr-card-label">' + qrItem.label + '</div>' +
                            '<div class="qr-card-meta">Created ' + dateStr + '</div>' +
                            '<div class="qr-card-badges">' + badges + '</div>' +
                            dataBoxesHTML +
                            '<div class="qr-card-actions">' +
                                '<button type="button" class="card-action-btn card-action-edit" id="editBtn-' + realIndex + '">‚úèÔ∏è Edit</button>' +
                                '<button type="button" class="card-action-btn card-action-download" id="dlBtn-' + realIndex + '">‚¨áÔ∏è PNG</button>' +
                            '</div>' +
                        '</div>';
                    
                    grid.appendChild(card);
                    
                    // Wire buttons directly with addEventListener (reliable in iframe)
                    var editBtn = document.getElementById('editBtn-' + realIndex);
                    if (editBtn) editBtn.addEventListener('click', function(ev) { ev.stopPropagation(); openEditQR(realIndex); });
                    
                    var dlBtn = document.getElementById('dlBtn-' + realIndex);
                    if (dlBtn) dlBtn.addEventListener('click', function(ev) { ev.stopPropagation(); quickDownloadQR(realIndex); });
                    
                    var dataArea = document.getElementById('cardData-' + realIndex);
                    if (dataArea && !batchEditMode) {
                        dataArea.addEventListener('click', function(ev) { ev.stopPropagation(); openDataViewer(realIndex); });
                    }
                    
                    if (batchEditMode) {
                        card.addEventListener('click', function(ev) {
                            if (ev.target.tagName === 'BUTTON') return;
                            batchToggleCard(realIndex);
                        });
                        var batchCb = document.getElementById('batchCb-' + realIndex);
                        if (batchCb) batchCb.addEventListener('change', function() { batchToggleCard(realIndex); });
                    }
                    
                    setTimeout(function() {
                        renderMiniQR('cardQR-' + realIndex, qrItem.url, qrItem.color, qrItem.includeLogo);
                    }, 10);
                    
                })(sorted[s], savedQRCodes.indexOf(sorted[s]));
            }
        }
        
        function renderMiniQR(canvasId, url, color, includeLogo) {
            var canvas = document.getElementById(canvasId);
            if (!canvas) return;
            var qr = qrcode(0, 'H');
            qr.addData(url);
            qr.make();
            var moduleCount = qr.getModuleCount();
            var cellSize = Math.floor(canvas.width / moduleCount);
            canvas.width = moduleCount * cellSize;
            canvas.height = moduleCount * cellSize;
            var ctx = canvas.getContext('2d');
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = color || '#C85A3E';
            for (var row = 0; row < moduleCount; row++) {
                for (var col = 0; col < moduleCount; col++) {
                    if (qr.isDark(row, col)) {
                        ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                    }
                }
            }
            if (includeLogo) drawLogoOnCanvas(canvas, color || '#C85A3E');
        }
        
        function openEditQR(index) {
            editingQRIndex = index;
            var qrItem = savedQRCodes[index];
            if (!qrItem) return;
            
            document.getElementById('editLabel').value = qrItem.label || '';
            document.getElementById('editDetails').value = qrItem.details || '';
            document.getElementById('editColor').value = qrItem.color || '#C85A3E';
            document.getElementById('editColorHex').value = qrItem.color || '#C85A3E';
            
            document.getElementById('editQRTitle').textContent = 'Edit: ' + qrItem.label;
            document.getElementById('editQRLabel').textContent = qrItem.label;
            document.getElementById('editQRUrl').textContent = qrItem.url;
            document.getElementById('editQRDate').textContent = 'Created ' + new Date(qrItem.createdAt).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            
            var statusEl = document.getElementById('editQRStatus');
            if (qrItem.status === 'active') {
                statusEl.textContent = '‚óè Active';
                statusEl.style.background = '#dcfce7';
                statusEl.style.color = '#166534';
            } else {
                statusEl.textContent = '‚óã Draft';
                statusEl.style.background = '#fee2e2';
                statusEl.style.color = '#991b1b';
            }
            
            // Load into edit store
            productDataStore['edit'] = {
                photo: qrItem.photo || null,
                filename: qrItem.filename || null,
                media: (qrItem.media || []).slice(),
                files: (qrItem.files || []).slice()
            };
            renderMediaList('edit');
            updateMediaPreview('edit');
            renderFileList('edit');
            
            // Render QR preview
            var previewDiv = document.getElementById('editQRPreview');
            previewDiv.innerHTML = '<canvas id="editQRCanvas" width="160" height="160"></canvas>';
            setTimeout(function() {
                renderMiniQR('editQRCanvas', qrItem.url, qrItem.color, qrItem.includeLogo);
            }, 10);
            
            // Show "Apply to All Selected" button if batch selection exists
            var applyAllDiv = document.getElementById('editApplyAllDiv');
            if (applyAllDiv) {
                var otherSelected = 0;
                batchSelectedIndices.forEach(function(idx) { if (idx !== index) otherSelected++; });
                if (batchSelectedIndices.size > 1 && batchSelectedIndices.has(index)) {
                    applyAllDiv.style.display = 'block';
                    applyAllDiv.innerHTML = '<div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 16px; text-align: center;">' +
                        '<p style="margin: 0 0 12px; font-size: 14px; color: #856404; font-weight: 600;">You have ' + batchSelectedIndices.size + ' QR codes selected</p>' +
                        '<button class="btn-primary" id="editApplyAllBtn" onclick="saveToAllSelected()" style="background: #C85A3E; font-size: 15px; padding: 14px 30px;">üíæ Save & Apply to All ' + batchSelectedIndices.size + ' Selected QR Codes</button>' +
                        '</div>';
                } else {
                    applyAllDiv.style.display = 'none';
                    applyAllDiv.innerHTML = '';
                }
            }
            
            showView('editQR');
        }
        
        function saveQREdits() {
            if (editingQRIndex === null) return;
            var qrItem = savedQRCodes[editingQRIndex];
            if (!qrItem) return;
            
            var newLabel = document.getElementById('editLabel').value.trim();
            var newDetails = document.getElementById('editDetails').value;
            var newColor = document.getElementById('editColor').value;
            var editStore = productDataStore['edit'] || {};
            
            qrItem.label = newLabel || qrItem.label;
            qrItem.details = newDetails;
            qrItem.color = newColor;
            qrItem.photo = editStore.photo || null;
            qrItem.media = (editStore.media || []).slice();
            qrItem.files = (editStore.files || []).slice();
            qrItem.updatedAt = new Date().toISOString();
            
            var hasContent = qrItem.details || qrItem.photo || qrItem.media.length > 0 || qrItem.files.length > 0;
            qrItem.status = hasContent ? 'active' : 'draft';
            
            // Update status badge
            var statusEl = document.getElementById('editQRStatus');
            if (qrItem.status === 'active') {
                statusEl.textContent = '‚óè Active';
                statusEl.style.background = '#dcfce7';
                statusEl.style.color = '#166534';
            } else {
                statusEl.textContent = '‚óã Draft';
                statusEl.style.background = '#fee2e2';
                statusEl.style.color = '#991b1b';
            }
            
            // Re-render QR with new color
            var previewDiv = document.getElementById('editQRPreview');
            previewDiv.innerHTML = '<canvas id="editQRCanvas" width="160" height="160"></canvas>';
            setTimeout(function() {
                renderMiniQR('editQRCanvas', qrItem.url, qrItem.color, qrItem.includeLogo);
            }, 10);
            
            document.getElementById('editQRTitle').textContent = 'Edit: ' + qrItem.label;
            document.getElementById('editQRLabel').textContent = qrItem.label;
            
            // Flash save confirmation
            var btns = document.querySelectorAll('#editQRView .btn-primary');
            if (btns[0]) {
                var origText = btns[0].innerHTML;
                var origBg = btns[0].style.background;
                btns[0].innerHTML = '‚úÖ Saved!';
                btns[0].style.background = '#22c55e';
                setTimeout(function() {
                    btns[0].innerHTML = origText;
                    btns[0].style.background = origBg;
                }, 2000);
            }
        }
        
        function saveToAllSelected() {
            var newDetails = document.getElementById('editDetails').value;
            var newColor = document.getElementById('editColor').value;
            var editStore = productDataStore['edit'] || {};
            var newPhoto = editStore.photo || null;
            var newMedia = (editStore.media || []).slice();
            var newFiles = (editStore.files || []).slice();
            
            var updated = 0;
            var indices = Array.from(batchSelectedIndices);
            for (var i = 0; i < indices.length; i++) {
                var qr = savedQRCodes[indices[i]];
                if (!qr) continue;
                
                qr.details = newDetails;
                qr.color = newColor;
                qr.photo = newPhoto;
                qr.media = newMedia.slice();
                qr.files = newFiles.slice();
                qr.updatedAt = new Date().toISOString();
                
                var hasContent = qr.details || qr.photo || qr.media.length > 0 || qr.files.length > 0;
                qr.status = hasContent ? 'active' : 'draft';
                updated++;
            }
            
            // Clear batch selection
            batchSelectedIndices.clear();
            batchEditMode = false;
            var toggleBtn = document.getElementById('batchEditToggle');
            if (toggleBtn) {
                toggleBtn.textContent = '‚úèÔ∏è Batch Edit';
                toggleBtn.style.background = '#3D2E24';
            }
            document.getElementById('batchSelectBar').style.display = 'none';
            document.getElementById('batchEditPanel').style.display = 'none';
            
            // Go back to My QR Codes and re-render
            renderMyCodes();
            updateQRCount();
            showView('myCodes');
        }
        
        function deleteQRCode() {
            if (editingQRIndex === null) return;
            savedQRCodes.splice(editingQRIndex, 1);
            editingQRIndex = null;
            updateQRCount();
            showView('myCodes');
        }
        
        function downloadEditQR() {
            if (editingQRIndex === null) return;
            var qrItem = savedQRCodes[editingQRIndex];
            if (!qrItem) return;
            
            var canvas = createHighResQR(qrItem.url, 400, qrItem.includeLogo);
            var ctx = canvas.getContext('2d');
            var imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            var pixels = imgData.data;
            var hex = qrItem.color || '#C85A3E';
            var cr = parseInt(hex.substring(1, 3), 16);
            var cg = parseInt(hex.substring(3, 5), 16);
            var cb = parseInt(hex.substring(5, 7), 16);
            
            for (var p = 0; p < pixels.length; p += 4) {
                if (pixels[p] < 128 && pixels[p + 1] < 128 && pixels[p + 2] < 128) {
                    pixels[p] = cr;
                    pixels[p + 1] = cg;
                    pixels[p + 2] = cb;
                }
            }
            ctx.putImageData(imgData, 0, 0);
            if (qrItem.includeLogo) drawLogoOnCanvas(canvas, hex);
            
            smartDownload(canvas.toDataURL('image/png'), 'duyen-' + qrItem.label + '.png');
        }
        
        function quickDownloadQR(index) {
            var qrItem = savedQRCodes[index];
            if (!qrItem) return;
            
            var canvas = createHighResQR(qrItem.url, 400, qrItem.includeLogo);
            var ctx = canvas.getContext('2d');
            var imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            var pixels = imgData.data;
            var hex = qrItem.color || '#C85A3E';
            var cr = parseInt(hex.substring(1, 3), 16);
            var cg = parseInt(hex.substring(3, 5), 16);
            var cb = parseInt(hex.substring(5, 7), 16);
            
            for (var p = 0; p < pixels.length; p += 4) {
                if (pixels[p] < 128 && pixels[p + 1] < 128 && pixels[p + 2] < 128) {
                    pixels[p] = cr;
                    pixels[p + 1] = cg;
                    pixels[p + 2] = cb;
                }
            }
            ctx.putImageData(imgData, 0, 0);
            if (qrItem.includeLogo) drawLogoOnCanvas(canvas, hex);
            
            smartDownload(canvas.toDataURL('image/png'), 'duyen-' + qrItem.label + '.png');
        }
        
        // ==============================
        // DATA VIEWER
        // ==============================
        
        function openDataViewer(index) {
            var qrItem = savedQRCodes[index];
            if (!qrItem) return;
            
            var modal = document.getElementById('dataViewerModal');
            var title = document.getElementById('dataViewerTitle');
            var content = document.getElementById('dataViewerContent');
            
            title.textContent = qrItem.label + ' ‚Äî Attached Data';
            
            var html = '';
            
            // Photos / Images
            var mediaItems = qrItem.media || [];
            var images = mediaItems.filter(function(m) { return m.type === 'image'; });
            var videos = mediaItems.filter(function(m) { return m.type === 'video'; });
            var audios = mediaItems.filter(function(m) { return m.type === 'audio'; });
            
            if (qrItem.photo || images.length > 0) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="color: #3D2E24; margin: 0 0 12px; font-size: 15px;">üì∏ Photos</h4>';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">';
                
                if (qrItem.photo) {
                    html += '<div style="border-radius: 10px; overflow: hidden; border: 2px solid #E8DDD6;"><img src="' + qrItem.photo + '" style="width: 100%; height: 140px; object-fit: cover; display: block;"></div>';
                }
                
                for (var ii = 0; ii < images.length; ii++) {
                    if (images[ii].data && images[ii].data !== qrItem.photo) {
                        html += '<div style="border-radius: 10px; overflow: hidden; border: 2px solid #E8DDD6;"><img src="' + images[ii].data + '" style="width: 100%; height: 140px; object-fit: cover; display: block;"></div>';
                    }
                }
                html += '</div></div>';
            }
            
            // Videos
            if (videos.length > 0) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="color: #3D2E24; margin: 0 0 12px; font-size: 15px;">üé¨ Videos</h4>';
                for (var vi = 0; vi < videos.length; vi++) {
                    html += '<div style="background: #1a1a2e; border-radius: 10px; padding: 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">';
                    html += '<span style="font-size: 28px;">üé¨</span>';
                    html += '<div><div style="color: white; font-weight: 600; font-size: 13px;">' + videos[vi].name + '</div>';
                    html += '<div style="color: #9A8478; font-size: 11px;">' + formatSize(videos[vi].size) + '</div></div>';
                    if (videos[vi].data) {
                        html += '<video controls style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 8px;" src="' + videos[vi].data + '"></video>';
                    }
                    html += '</div>';
                }
                html += '</div>';
            }
            
            // Audio
            if (audios.length > 0) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="color: #3D2E24; margin: 0 0 12px; font-size: 15px;">üéµ Audio / Voice Memos</h4>';
                for (var ai = 0; ai < audios.length; ai++) {
                    html += '<div style="background: #f3f0ff; border-radius: 10px; padding: 12px; margin-bottom: 8px;">';
                    html += '<div style="font-weight: 600; font-size: 13px; color: #5b21b6; margin-bottom: 8px;">üéµ ' + audios[ai].name + ' <span style="font-weight: 400; color: #9A8478;">(' + formatSize(audios[ai].size) + ')</span></div>';
                    if (audios[ai].data) {
                        html += '<audio controls style="width: 100%;" src="' + audios[ai].data + '"></audio>';
                    }
                    html += '</div>';
                }
                html += '</div>';
            }
            
            // Files
            var fileItems = qrItem.files || [];
            if (fileItems.length > 0) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="color: #3D2E24; margin: 0 0 12px; font-size: 15px;">üìé Files (' + fileItems.length + ')</h4>';
                for (var fi = 0; fi < fileItems.length; fi++) {
                    var fItem = fileItems[fi];
                    var fIcon = getFileIcon(fItem.name);
                    html += '<div style="display: flex; align-items: center; gap: 10px; background: #f8fafc; border: 1px solid #E8DDD6; border-radius: 10px; padding: 12px; margin-bottom: 8px;">';
                    html += '<span style="font-size: 28px;">' + fIcon + '</span>';
                    html += '<div style="flex: 1; min-width: 0;"><div style="font-weight: 600; font-size: 13px; color: #3D2E24; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + fItem.name + '</div>';
                    html += '<div style="color: #9A8478; font-size: 11px;">' + formatSize(fItem.size) + ' ¬∑ ' + (fItem.mimeType || 'file') + '</div></div>';
                    if (fItem.data) {
                        html += '<button type="button" class="viewerFileBtn" id="viewerFile-' + fi + '" style="background: #C85A3E; color: white; border: none; padding: 8px 14px; border-radius: 8px; font-weight: 700; font-size: 12px; cursor: pointer; white-space: nowrap;">Open ‚Üó</button>';
                    }
                    html += '</div>';
                }
                html += '</div>';
            }
            
            // Details text
            if (qrItem.details) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="color: #3D2E24; margin: 0 0 12px; font-size: 15px;">üìù Product Details</h4>';
                html += '<div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 10px; padding: 16px; font-size: 14px; line-height: 1.7; white-space: pre-wrap; color: #333;">' + qrItem.details + '</div>';
                html += '</div>';
            }
            
            // No data
            if (!html) {
                html = '<div style="text-align: center; padding: 40px; color: #9A8478;"><div style="font-size: 48px; margin-bottom: 12px;">üì≠</div><p>No data attached to this QR code yet.</p></div>';
            }
            
            // Edit button at bottom
            html += '<div style="text-align: center; padding-top: 12px; border-top: 1px solid #E8DDD6;">';
            html += '<button type="button" id="dataViewerEditBtn" data-edit-idx="' + index + '" style="background: #C85A3E; color: white; border: none; padding: 12px 30px; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer;">‚úèÔ∏è Edit This QR Code</button>';
            html += '</div>';
            
            content.innerHTML = html;
            modal.style.display = 'block';
            
            // Wire file Open buttons
            for (var fb = 0; fb < fileItems.length; fb++) {
                (function(fileIdx) {
                    var btn = document.getElementById('viewerFile-' + fileIdx);
                    if (btn && fileItems[fileIdx].data) {
                        btn.addEventListener('click', function() {
                            var f = fileItems[fileIdx];
                            smartDownload(f.data, f.name);
                        });
                    }
                })(fb);
            }
            
            // Wire edit button inside modal
            var editBtn = document.getElementById('dataViewerEditBtn');
            if (editBtn) {
                editBtn.addEventListener('click', function() {
                    modal.style.display = 'none';
                    openEditQR(parseInt(this.dataset.editIdx));
                });
            }
        }
        
        // Close data viewer modal - wire after DOM ready
        function closeDataViewer() {
            var modal = document.getElementById('dataViewerModal');
            if (modal) modal.style.display = 'none';
            var mediaEls = document.querySelectorAll('#dataViewerContent audio, #dataViewerContent video');
            for (var i = 0; i < mediaEls.length; i++) { mediaEls[i].pause(); }
        }
        
        // Wire close button and backdrop click
        setTimeout(function() {
            var closeBtn = document.getElementById('dataViewerClose');
            if (closeBtn) closeBtn.addEventListener('click', closeDataViewer);
            
            var modal = document.getElementById('dataViewerModal');
            if (modal) modal.addEventListener('click', function(e) {
                if (e.target === modal) closeDataViewer();
            });
            
            // Auth modal close
            var authClose = document.getElementById('authModalClose');
            if (authClose) authClose.addEventListener('click', function() {
                document.getElementById('authModal').classList.remove('active');
            });
            var authModal = document.getElementById('authModal');
            if (authModal) authModal.addEventListener('click', function(e) {
                if (e.target === authModal) authModal.classList.remove('active');
            });
            
            // Footer About link
            var footerAbout = document.getElementById('footerAboutLink');
            if (footerAbout) footerAbout.addEventListener('click', function() {
                showView('about');
            });
            
            // About back button
            var aboutBack = document.getElementById('aboutBackBtn');
            if (aboutBack) aboutBack.addEventListener('click', function() {
                showView('landing');
            });
            
            // Header About button
            var headerAbout = document.getElementById('headerAboutBtn');
            if (headerAbout) headerAbout.addEventListener('click', function() {
                showView('about');
            });
        }, 100);
        
        // ==============================
        // BATCH EDIT FUNCTIONS
        // ==============================
        
        function toggleBatchEditMode() {
            batchEditMode = !batchEditMode;
            batchSelectedIndices.clear();
            
            var toggleBtn = document.getElementById('batchEditToggle');
            var selectBar = document.getElementById('batchSelectBar');
            var editPanel = document.getElementById('batchEditPanel');
            
            if (batchEditMode) {
                toggleBtn.textContent = '‚úï Exit Batch Edit';
                toggleBtn.style.background = '#c53030';
                selectBar.style.display = 'block';
            } else {
                toggleBtn.textContent = '‚úèÔ∏è Batch Edit';
                toggleBtn.style.background = '#3D2E24';
                selectBar.style.display = 'none';
                editPanel.style.display = 'none';
                batchResetEditPanel();
            }
            
            batchUpdateCounts();
            renderMyCodes();
        }
        
        // Wire batch toolbar buttons
        (function wireBatchButtons() {
            function wire(id, fn) {
                var el = document.getElementById(id);
                if (el) el.addEventListener('click', fn);
            }
            function wireChange(id, fn) {
                var el = document.getElementById(id);
                if (el) el.addEventListener('change', fn);
            }
            
            // Batch Edit toggle button
            wire('batchEditToggle', toggleBatchEditMode);
            
            // Selection bar buttons (always visible when batch mode on)
            wireChange('batchSelectAll', batchToggleAll);
            wire('batchEditBtn', batchShowEditPanel);
            wire('batchDeleteBtn', batchDeleteSelected);
            wire('batchCancelBtn', toggleBatchEditMode);
        })();
        
        function batchToggleCard(index) {
            if (batchSelectedIndices.has(index)) {
                batchSelectedIndices.delete(index);
            } else {
                batchSelectedIndices.add(index);
            }
            batchUpdateCounts();
            renderMyCodes();
        }
        
        function batchToggleAll() {
            var selectAllCb = document.getElementById('batchSelectAll');
            if (selectAllCb.checked) {
                savedQRCodes.forEach(function(_, i) {
                    batchSelectedIndices.add(i);
                });
            } else {
                batchSelectedIndices.clear();
            }
            batchUpdateCounts();
            renderMyCodes();
        }
        
        function batchUpdateCounts() {
            var count = batchSelectedIndices.size;
            
            var countEl = document.getElementById('batchSelectedCount');
            if (countEl) countEl.textContent = '(' + count + ' selected)';
            
            var editBtn = document.getElementById('batchEditBtn');
            var delBtn = document.getElementById('batchDeleteBtn');
            if (editBtn) {
                editBtn.style.opacity = count > 0 ? '1' : '0.4';
                editBtn.style.pointerEvents = count > 0 ? 'auto' : 'none';
            }
            if (delBtn) {
                delBtn.style.opacity = count > 0 ? '1' : '0.4';
                delBtn.style.pointerEvents = count > 0 ? 'auto' : 'none';
            }
            
            var selectAllCb = document.getElementById('batchSelectAll');
            if (selectAllCb && savedQRCodes.length > 0) {
                selectAllCb.checked = count === savedQRCodes.length;
                selectAllCb.indeterminate = count > 0 && count < savedQRCodes.length;
            }
            
            var editCountEl = document.getElementById('batchEditCount');
            if (editCountEl) editCountEl.textContent = count;
            var applyCountEl = document.getElementById('batchApplyCount');
            if (applyCountEl) applyCountEl.textContent = count;
        }
        
        function batchShowEditPanel() {
            if (batchSelectedIndices.size === 0) return;
            
            // Reset panel
            batchResetEditPanel();
            
            // Initialize batch productDataStore
            productDataStore['batch'] = { media: [], files: [] };
            renderMediaList('batch');
            renderFileList('batch');
            updateMediaPreview('batch');
            
            document.getElementById('batchEditPanel').style.display = 'block';
            document.getElementById('batchEditPanel').scrollIntoView({ behavior: 'smooth' });
        }
        
        function batchHideEditPanel() {
            document.getElementById('batchEditPanel').style.display = 'none';
            batchResetEditPanel();
        }
        
        function batchResetEditPanel() {
            document.getElementById('batchDetails').value = '';
            document.getElementById('batchColor').value = '#C85A3E';
            document.getElementById('batchColorHex').value = '#C85A3E';
            var colorCb = document.getElementById('batchColorApply');
            if (colorCb) colorCb.checked = false;
            
            productDataStore['batch'] = { media: [], files: [] };
            
            var mediaList = document.getElementById('mediaList-batch');
            if (mediaList) mediaList.innerHTML = '';
            var fileList = document.getElementById('fileList-batch');
            if (fileList) fileList.innerHTML = '';
            
            var preview = document.getElementById('preview-batch');
            if (preview) preview.innerHTML = '<div style="font-size: 30px; margin-bottom: 4px;">üì∑ üé•</div><div style="color: #C85A3E; font-weight: 600; font-size: 13px;">Click to upload media</div>';
            
            var filePreview = document.getElementById('filePreview-batch');
            if (filePreview) filePreview.innerHTML = '<div style="font-size: 28px; margin-bottom: 4px;">üìÅ</div><div style="color: #3D2E24; font-weight: 600; font-size: 13px;">Click to upload files</div>';
        }
        
        function batchApplyEdits() {
            var count = batchSelectedIndices.size;
            if (count === 0) return;
            
            // Read values
            var newDetails = document.getElementById('batchDetails').value;
            var newColor = document.getElementById('batchColor').value;
            var colorApply = document.getElementById('batchColorApply');
            var applyColor = false;
            if (colorApply) {
                // Check both property and attribute
                applyColor = colorApply.checked || colorApply.getAttribute('checked') !== null;
            }
            var batchStore = productDataStore['batch'] || {};
            var newMedia = (batchStore.media || []).slice();
            var newPhoto = batchStore.photo || null;
            var newFiles = (batchStore.files || []).slice();
            
            // Auto-detect what to apply
            var hasDetails = newDetails.length > 0;
            var hasMedia = newMedia.length > 0 || newPhoto;
            var hasFiles = newFiles.length > 0;
            
            if (!hasDetails && !hasMedia && !hasFiles && !applyColor) {
                var btn = document.getElementById('batchApplyBtn');
                if (btn) {
                    var orig = btn.innerHTML;
                    btn.innerHTML = '‚ö†Ô∏è Nothing to apply ‚Äî add content first';
                    btn.style.background = '#f59e0b';
                    setTimeout(function() { btn.innerHTML = orig; btn.style.background = ''; }, 2500);
                }
                return;
            }
            
            // Apply to all selected
            var updated = 0;
            var indices = Array.from(batchSelectedIndices);
            for (var i = 0; i < indices.length; i++) {
                var qr = savedQRCodes[indices[i]];
                if (!qr) continue;
                
                if (hasDetails) qr.details = newDetails;
                if (hasMedia) { qr.media = newMedia.slice(); qr.photo = newPhoto; }
                if (hasFiles) qr.files = newFiles.slice();
                if (applyColor) qr.color = newColor;
                
                qr.updatedAt = new Date().toISOString();
                var hasContent = qr.details || qr.photo || (qr.media && qr.media.length > 0) || (qr.files && qr.files.length > 0);
                qr.status = hasContent ? 'active' : 'draft';
                updated++;
            }
            
            // Hide panel and exit batch mode immediately
            document.getElementById('batchEditPanel').style.display = 'none';
            batchEditMode = false;
            batchSelectedIndices.clear();
            var toggleBtn = document.getElementById('batchEditToggle');
            if (toggleBtn) {
                toggleBtn.textContent = '‚úèÔ∏è Batch Edit';
                toggleBtn.style.background = '#3D2E24';
            }
            document.getElementById('batchSelectBar').style.display = 'none';
            
            // Re-render cards immediately with updated data
            renderMyCodes();
            updateQRCount();
        }
        
        function batchDeleteSelected() {
            var count = batchSelectedIndices.size;
            if (count === 0) return;
            
            // Delete in reverse order to preserve indices
            var indices = Array.from(batchSelectedIndices).sort(function(a, b) { return b - a; });
            indices.forEach(function(idx) {
                savedQRCodes.splice(idx, 1);
            });
            
            batchSelectedIndices.clear();
            updateQRCount();
            batchUpdateCounts();
            
            // If no codes left, exit batch mode
            if (savedQRCodes.length === 0) {
                batchEditMode = false;
                var toggleBtn = document.getElementById('batchEditToggle');
                toggleBtn.textContent = '‚úèÔ∏è Batch Edit';
                toggleBtn.style.background = '#3D2E24';
                document.getElementById('batchSelectBar').style.display = 'none';
                document.getElementById('batchEditPanel').style.display = 'none';
            }
            
            renderMyCodes();
        }
    </script>
</body>
</html>
